<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adventure Planner – Debug Mode</title>

    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

    <script>
        // ============================
        // MSAL CONFIG
        // ============================
        const msalConfig = {
            auth: {
                clientId: "54cd5065-43b4-4f98-9390-0fbba95da3f2",
                authority: "https://login.microsoftonline.com/5b9b0c40-0a71-4cc2-a98a-8a1fc03a20bc",
                redirectUri: window.location.origin
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const loginRequest = {
            scopes: ["User.Read", "Files.ReadWrite", "Sites.ReadWrite.All"]
        };

        let accessToken = null;

        // ============================
        // SIGN IN
        // ============================
        async function signIn() {
            try {
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                console.log("Logged in:", loginResponse.account);

                msalInstance.setActiveAccount(loginResponse.account);

                const tokenResponse = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account: loginResponse.account
                });

                accessToken = tokenResponse.accessToken;
                console.log("Access token acquired");

                // ⭐ DEBUG 1 — List root folders
                await debugListRoot();

                // ⭐ DEBUG 2 — List Copilot_Apps folder
                await debugListCopilotApps();

                // ⭐ Attempt to load table (will work once we know exact file name)
                await loadTable();

            } catch (error) {
                console.error(error);
            }
        }

        // ============================
        // DEBUG: LIST ROOT
        // ============================
        async function debugListRoot() {
            const url = "https://graph.microsoft.com/v1.0/me/drive/root/children";

            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            const data = await response.json();
            console.log("ROOT CHILDREN:", data);
        }

        // ============================
        // DEBUG: LIST Copilot_Apps
        // ============================
        async function debugListCopilotApps() {
            const url = "https://graph.microsoft.com/v1.0/me/drive/root:/Copilot_Apps:/children";

            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            const data = await response.json();
            console.log("COPILOT_APPS CHILDREN:", data);
        }

        // ============================
        // LOAD TABLE (will fix path after debug)
        // ============================
        async function loadTable() {
            if (!accessToken) return;

            // TEMPORARY — will replace once we see the real file name
            const filePath = "Copilot_Apps/Adventure_Finder_Excel_DB.xlsx";

            const url =
                `https://graph.microsoft.com/v1.0/me/drive/root:/${filePath}:/workbook/tables/MyList/rows`;

            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            const data = await response.json();
            console.log("Excel rows:", data);

            if (!data.value) {
                console.log("Table is empty or returned no rows");
                return;
            }
        }
    </script>
</head>

<body>
    <h1>Adventure Planner Debug Mode</h1>
    <button onclick="signIn()">Sign In</button>
</body>
</html>
