<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adventure Planner ‚Äì Debug Tables</title>

    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

    <script>
        const msalConfig = {
            auth: {
                clientId: "54cd5065-43b4-4f98-9390-0fbba95da3f2",
                authority: "https://login.microsoftonline.com/5b9b0c40-0a71-4cc2-a98a-8a1fc03a20bc",
                redirectUri: window.location.origin
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const loginRequest = {
            scopes: ["User.Read", "Files.ReadWrite", "Sites.ReadWrite.All"]
        };

        let accessToken = null;

        // This is now 100% confirmed from your logs:
        const filePath = "Copilot_Apps/Kyles_Adventure_Finder/Adventure_Finder_Excel_DB.xlsx";

        async function signIn() {
            try {
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                console.log("Logged in:", loginResponse.account);

                msalInstance.setActiveAccount(loginResponse.account);

                const tokenResponse = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account: loginResponse.account
                });

                accessToken = tokenResponse.accessToken;
                console.log("Access token acquired");

                await debugListRoot();
                await debugListCopilotApps();
                await debugListExcelFolder();
                await debugListTables();   // ‚≠ê NEW: list tables in the workbook
                await loadTable();         // will work once table name is correct

            } catch (error) {
                console.error(error);
            }
        }

        async function debugListRoot() {
            const url = "https://graph.microsoft.com/v1.0/me/drive/root/children";
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            const data = await response.json();
            console.log("ROOT CHILDREN:", data);
        }

        async function debugListCopilotApps() {
            const url = "https://graph.microsoft.com/v1.0/me/drive/root:/Copilot_Apps:/children";
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            const data = await response.json();
            console.log("COPILOT_APPS CHILDREN:", data);
        }

        async function debugListExcelFolder() {
            const url = "https://graph.microsoft.com/v1.0/me/drive/root:/Copilot_Apps/Kyles_Adventure_Finder:/children";
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            const data = await response.json();
            console.log("EXCEL FOLDER CHILDREN:", data);
        }

        // ‚≠ê NEW: list tables in the workbook
        async function debugListTables() {
            const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${filePath}:/workbook/tables`;
            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            const data = await response.json();
            console.log("WORKBOOK TABLES:", data);
        }

        async function loadTable() {
            if (!accessToken) return;

            // üî¥ TEMP: replace "MyList" with the actual table name from WORKBOOK TABLES output
            const tableName = "MyList";

            const url =
                `https://graph.microsoft.com/v1.0/me/drive/root:/${filePath}:/workbook/tables/${tableName}/rows`;

            const response = await fetch(url, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            const data = await response.json();
            console.log("Excel rows:", data);

            if (!data.value) {
                console.log("Table is empty or returned no rows");
                return;
            }
        }
    </script>
</head>

<body>
    <h1>Adventure Planner ‚Äì Table Debug</h1>
    <button onclick="signIn()">Sign In</button>
</body>
</html>
