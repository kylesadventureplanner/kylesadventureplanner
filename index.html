<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Adventure Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ============================================================
       COLOR SYSTEM & DESIGN TOKENS
       ============================================================
       This :root section defines all the colors used throughout the app.
       Using CSS variables makes it easy to maintain a consistent color
       scheme and allows for easy theme changes in the future.

       COLOR PALETTE:
       - Mint: Green colors for positive actions (success, filters, nature)
       - Blue: Primary colors for main actions, buttons, and highlights
       - Gray: Neutral colors for borders, backgrounds, and text
       - Soft Yellow: Warning/caution colors for softer alerts
       - Danger Red: Error and critical state indicators
    */
    :root {
      --mint-bg: #ecfdf5;        /* Light mint background for cards/highlights */
      --mint-border: #6ee7b7;    /* Mint color for borders and accents */
      --mint-strong: #10b981;    /* Dark mint for strong/prominent text */
      --blue-bg: #e0f2fe;        /* Light blue background for highlights */
      --blue-border: #60a5fa;    /* Blue for borders and accents */
      --blue-strong: #1d4ed8;    /* Dark blue for primary actions and text */
      --gray-border: #d1d5db;    /* Gray for subtle borders */
      --gray-text: #374151;      /* Gray for regular text content */
      --soft-yellow: #fef9c3;    /* Soft yellow for warnings */
      --soft-yellow-border: #facc15; /* Yellow for warning borders */
      --danger-red: #dc2626;     /* Red for errors and danger states */
    }

    /* ============================================================
       GLOBAL STYLES
       ============================================================
       These styles apply to all elements and establish the overall
       look and feel of the application.
    */
    * {
      box-sizing: border-box; /* Include padding/border in width calculations */
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f9fafb; /* Light gray background for the entire page */
      color: #111827;      /* Dark gray text for readability */
    }

    /* App container - limits max width and centers content */
    .app-container {
      max-width: 1200px; /* Desktop layout width */
      margin: 0 auto;    /* Center on page */
      padding: 16px;     /* Padding around edges */
    }

    /* ============================================================
       HEADER & TOP NAVIGATION
       ============================================================
       The header contains the app title, status indicators, and controls.
    */
    header {
      display: flex;
      justify-content: space-between; /* Title on left, buttons on right */
      align-items: center;
      margin-bottom: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    /* ============================================================
       BUTTONS & INTERACTIVE ELEMENTS
       ============================================================
       Various button styles for different purposes throughout the app.
    */

    /* iPhone/Mobile toggle button - switches between desktop and mobile view */
    .iphone-toggle-btn {
      padding: 6px 12px;
      border-radius: 999px;  /* Pill-shaped button */
      border: 1px solid var(--blue-border);
      background: white;
      color: var(--blue-strong);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Active state for iPhone toggle - shows when in mobile view mode */
    .iphone-toggle-btn.active {
      background: var(--blue-bg); /* Highlighted when active */
    }

    /* ============================================================
       STATUS BAR
       ============================================================
       Displays connection status to Excel backend and other system info.
    */
    .status-bar {
      display: flex;
      justify-content: space-between; /* Content spread across width */
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      background: white;
      border: 1px solid var(--gray-border);
      margin-bottom: 12px;
      font-size: 13px;
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 8px; /* Space between dot and text */
    }

    /* Visual dot indicator showing connection status */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px; /* Circle shape */
    }

    /* Green dot = connected to Excel */
    .status-dot.connected {
      background: #22c55e;
    }

    /* Red dot = disconnected from Excel */
    .status-dot.disconnected {
      background: var(--danger-red);
    }

    .status-text {
      font-weight: 500;
    }

    /* ============================================================
       FILTER STATUS INDICATOR
       ============================================================
       Shows when active filters are applied to the table.
    */
    .filters-active-badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--mint-bg);
      border: 1px solid var(--mint-border);
      color: var(--mint-strong);
      font-size: 11px;
      font-weight: 600;
      display: none; /* Hidden by default */
    }

    /* Badge appears when any filters are active */
    .filters-active-badge.visible {
      display: inline-flex;
    }

    /* ============================================================
       CARD LAYOUT SYSTEM
       ============================================================
       Cards are the main containers for different sections of the app.
       Each card has a header with title and buttons, then content area.
    */
    .card {
      background: white;
      border-radius: 10px;
      border: 1px solid var(--gray-border);
      padding: 12px 14px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between; /* Title on left, buttons on right */
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      font-size: 12px;
      color: #6b7280; /* Muted gray text */
    }

    .pill-button {
      border-radius: 999px;
      border: 1px solid var(--gray-border);
      background: #f3f4f6;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .pill-button:hover {
      background: #e5e7eb;
    }

    .pill-button.reset {
      border-color: var(--mint-border);
      color: var(--mint-strong);
      background: white;
    }

    .pill-button.reset:hover {
      background: var(--mint-bg);
    }

    .control-panel-card.filters-active,
    .quick-filters-card.filters-active {
      background: var(--mint-bg);
      border-color: var(--mint-border);
    }

    .control-panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      width: 100%;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-item label {
      font-size: 12px;
      color: #4b5563;
    }

    .filter-input,
    .filter-select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--gray-border);
      font-size: 13px;
      color: var(--gray-text);
      background: white;
    }

    .filter-input::placeholder {
      color: #9ca3af;
    }

    .quick-filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .quick-filter-btn {
      border-radius: 999px;
      border: 1px solid var(--gray-border);
      background: #f3f4f6;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .quick-filter-btn:hover {
      background: #e5e7eb;
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .quick-filter-btn.active {
      background: var(--mint-bg);
      border-color: var(--mint-border);
      color: var(--mint-strong);
      font-weight: 600;
    }
      border-color: var(--mint-border);
      color: var(--mint-strong);
      font-weight: 600;
    }

    /* Google Automation Card */
    .automation-card {
      border-color: var(--blue-border);
      background: #f9fafb;
      padding: 0;
      overflow: hidden;
    }

    .automation-header {
      background: var(--blue-bg);
      border-bottom: 1px solid var(--blue-border);
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .automation-header-title {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--blue-strong);
    }

    .automation-body {
      padding: 10px 12px 12px;
    }

    .automation-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .automation-btn {
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: white;
      color: var(--blue-strong);
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .automation-btn:hover {
      background: var(--blue-bg);
    }

    .dry-run-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .dry-run-switch {
      width: 32px;
      height: 18px;
      border-radius: 999px;
      background: #e5e7eb;
      position: relative;
      transition: background 0.2s;
    }

    .dry-run-switch-thumb {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: white;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .dry-run-toggle.on .dry-run-switch {
      background: var(--blue-border);
    }

    .dry-run-toggle.on .dry-run-switch-thumb {
      transform: translateX(14px);
    }

    .dry-run-note {
      font-size: 11px;
      color: #6b7280;
    }

    /* Table Wrapper - Container for scrollable table */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      overflow-y: visible;
      -webkit-overflow-scrolling: touch;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    /* Table */
    .table-card {
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: auto;
    }

    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th, td {
      padding: 8px 8px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
      word-wrap: break-word;
    }

    th {
      text-align: left;
      font-size: 12px;
      color: #4b5563;
      font-weight: 600;
      white-space: nowrap;
    }

    tr:hover {
      background: #f9fafb;
    }

    tr.row-selected {
      background: var(--soft-yellow);
      border-left: 4px solid var(--soft-yellow-border);
    }

    .text-cell-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .description-preview,
    .hours-preview {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      font-size: 12px;
      color: #4b5563;
    }

    .description-full,
    .hours-full {
      display: none;
      font-size: 12px;
      color: #4b5563;
    }

    .more-less-btn {
      align-self: flex-start;
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: var(--blue-bg);
      color: var(--blue-strong);
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    .more-less-btn:hover {
      background: #bfdbfe;
    }

    /* Tag pills (example base styles) */
    .tag-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin: 1px 2px 1px 0;
      color: #111827;
    }

    /* Tag Icons - Graphical representation of each tag type */
    /* Each tag type has a unique background color and emoji/icon */

    /* Restaurant - Fork and Knife */
    .tag-restaurant {
      background: #fee2e2;
    }
    .tag-restaurant::before {
      content: "üçΩÔ∏è ";
    }

    /* Animals - Paw Print */
    .tag-animals {
      background: #dcfce7;
    }
    .tag-animals::before {
      content: "üêæ ";
    }

    /* Hiking - Mountain */
    .tag-hiking {
      background: #dbeafe;
    }
    .tag-hiking::before {
      content: "‚õ∞Ô∏è ";
    }

    /* Garden Center - Flower */
    .tag-garden-center {
      background: #fef3c7;
    }
    .tag-garden-center::before {
      content: "üå∏ ";
    }

    /* Orchards - Apple */
    .tag-orchards {
      background: #fef9c3;
    }
    .tag-orchards::before {
      content: "üçé ";
    }

    /* Ziplining - Parachute */
    .tag-ziplining {
      background: #e0f2fe;
    }
    .tag-ziplining::before {
      content: "ü™Ç ";
    }

    /* Market - Shopping Cart */
    .tag-market {
      background: #ede9fe;
    }
    .tag-market::before {
      content: "üõí ";
    }

    /* Scenic Drive - Road */
    .tag-scenic-drive {
      background: #e0f2fe;
    }
    .tag-scenic-drive::before {
      content: "üõ£Ô∏è ";
    }

    /* Nature - Tree */
    .tag-nature {
      background: #dcfce7;
    }
    .tag-nature::before {
      content: "üå≥ ";
    }

    /* Attractions - Star */
    .tag-attractions {
      background: #e5e7eb;
    }
    .tag-attractions::before {
      content: "‚≠ê ";
    }

    /* Used Book Store - Book */
    .tag-used-book-store {
      background: #fef3c7;
    }
    .tag-used-book-store::before {
      content: "üìö ";
    }

    /* Entertainment / Music - Musical Note */
    .tag-entertainment,
    .tag-music {
      background: #fce7f3;
    }
    .tag-entertainment::before,
    .tag-music::before {
      content: "üéµ ";
    }

    /* Online Shop / Local Shop - Online Store */
    .tag-online-shop,
    .tag-local-shop {
      background: #e0e7ff;
    }
    .tag-online-shop::before,
    .tag-local-shop::before {
      content: "üõçÔ∏è ";
    }

    /* Grocery Market - Grocery Bag */
    .tag-grocery-market {
      background: #dcfce7;
    }
    .tag-grocery-market::before {
      content: "üõí ";
    }

    /* Nursery / Garden - Plant */
    .tag-nursery,
    .tag-garden {
      background: #fef3c7;
    }
    .tag-nursery::before,
    .tag-garden::before {
      content: "üå± ";
    }

    /* Drive Up / Drive Through - Car */
    .tag-drive-up,
    .tag-drive-through {
      background: #e0f2fe;
    }
    .tag-drive-up::before,
    .tag-drive-through::before {
      content: "üöó ";
    }

    /* Waterfall - Water Wave */
    .tag-waterfall,
    .tag-waterfalls {
      background: #e0f2fe;
    }
    .tag-waterfall::before,
    .tag-waterfalls::before {
      content: "üíß ";
    }

    /* Camping / Hiking Camping - Tent */
    .tag-camping,
    .tag-hiking-camping {
      background: #d4fc79;
    }
    .tag-camping::before,
    .tag-hiking-camping::before {
      content: "‚õ∫ ";
    }

    /* Farms / Petting Zoos / Farm - Barn */
    .tag-farms,
    .tag-petting-zoos,
    .tag-farm,
    .tag-farms-petting-zoos {
      background: #fef9c3;
    }
    .tag-farms::before,
    .tag-petting-zoos::before,
    .tag-farm::before,
    .tag-farms-petting-zoos::before {
      content: "üöú ";
    }

    /* Goat Cheese Farm / Cheese Shop - Cheese */
    .tag-goat-cheese-farm,
    .tag-cheese-shop {
      background: #fef3c7;
    }
    .tag-goat-cheese-farm::before,
    .tag-cheese-shop::before {
      content: "üßÄ ";
    }

    /* Butcher Shop - Meat */
    .tag-butcher-shop {
      background: #fee2e2;
    }
    .tag-butcher-shop::before {
      content: "ü•© ";
    }

    /* Climbing / Climbing Course - Rock Climber */
    .tag-climbing,
    .tag-climbing-course {
      background: #e0f2fe;
    }
    .tag-climbing::before,
    .tag-climbing-course::before {
      content: "üßó ";
    }

    /* Ziplining Rappelling - Rope */
    .tag-ziplining-rappelling,
    .tag-rappelling {
      background: #e0f2fe;
    }
    .tag-ziplining-rappelling::before,
    .tag-rappelling::before {
      content: "ü™Ç ";
    }

    /* Arts and Crafts - Artist Palette */
    .tag-arts-and-crafts,
    .tag-arts,
    .tag-crafts {
      background: #fce7f3;
    }
    .tag-arts-and-crafts::before,
    .tag-arts::before,
    .tag-crafts::before {
      content: "üé® ";
    }

    /* Aquariums - Fish */
    .tag-aquariums {
      background: #e0f2fe;
    }
    .tag-aquariums::before {
      content: "üê† ";
    }

    /* Live Music - Microphone */
    .tag-live-music {
      background: #fce7f3;
    }
    .tag-live-music::before {
      content: "üé§ ";
    }

    /* Flea Market - Flea */
    .tag-flea-market {
      background: #ede9fe;
    }
    .tag-flea-market::before {
      content: "üè™ ";
    }

    /* Turkish Coffee - Coffee Cup */
    .tag-turkish-coffee,
    .tag-coffee {
      background: #fef3c7;
    }
    .tag-turkish-coffee::before,
    .tag-coffee::before {
      content: "‚òï ";
    }

    /* Traditional Middle Eastern Food - Plate */
    .tag-traditional-middle-eastern-food {
      background: #fee2e2;
    }
    .tag-traditional-middle-eastern-food::before {
      content: "üçΩÔ∏è ";
    }

    /* German Pretzels - Pretzel */
    .tag-german-pretzels,
    .tag-pretzels {
      background: #fee2e2;
    }
    .tag-german-pretzels::before,
    .tag-pretzels::before {
      content: "ü•® ";
    }

    /* German Pub - Beer Mug */
    .tag-german-pub,
    .tag-pub {
      background: #fee2e2;
    }
    .tag-german-pub::before,
    .tag-pub::before {
      content: "üç∫ ";
    }

    /* Mexican Ice Cream - Ice Cream */
    .tag-mexican-ice-cream,
    .tag-ice-cream {
      background: #fee2e2;
    }
    .tag-mexican-ice-cream::before,
    .tag-ice-cream::before {
      content: "üç¶ ";
    }

    /* Take Out Only - Takeout Box */
    .tag-take-out-only,
    .tag-takeout {
      background: #fee2e2;
    }
    .tag-take-out-only::before,
    .tag-takeout::before {
      content: "üì¶ ";
    }

    /* European Market - European Flag */
    .tag-european-market,
    .tag-polish-deli {
      background: #ede9fe;
    }
    .tag-european-market::before,
    .tag-polish-deli::before {
      content: "üá™üá∫ ";
    }

    /* Scenic - Scenic View */
    .tag-scenic {
      background: #e0f2fe;
    }
    .tag-scenic::before {
      content: "üåÖ ";
    }

    /* Default style for any unknown tags */
    [class*="tag-"] {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin: 1px 2px 1px 0;
      color: #111827;
      /* Default light gray if no specific style */
      background: #f3f4f6;
    }
    #adventureTable th.hidden-by-default,
    #adventureTable td.hidden-by-default {
      display: none;
    }

    #adventureTable.show-all-columns th.hidden-by-default,
    #adventureTable.show-all-columns td.hidden-by-default {
      display: table-cell;
    }

    .columns-toggle-btn {
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: var(--blue-bg);
      color: var(--blue-strong);
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
    }

    .columns-toggle-btn:hover {
      background: #bfdbfe;
    }

    /* Find Near Me Feature */
    .find-near-me-btn {
      border-radius: 999px;
      border: 1px solid #10b981;
      background: #ecfdf5;
      color: #047857;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .find-near-me-btn:hover {
      background: #d1fae5;
    }

    .find-near-me-btn.loading {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .distance-pill {
      display: inline-block;
      background: #ecfdf5;
      border: 1px solid #6ee7b7;
      color: #047857;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    /* Mobile / iPhone view overrides */
    body.mobile-view .control-panel-grid {
      grid-template-columns: 1fr;
    }

    body.mobile-view .quick-filters-container {
      flex-direction: column;
    }

    body.mobile-view .quick-filter-btn,
    body.mobile-view .pill-button.reset,
    body.mobile-view .automation-btn {
      width: 100%;
      text-align: center;
    }

    body.mobile-view table {
      font-size: 12px;
    }

    body.mobile-view th,
    body.mobile-view td {
      padding: 6px 6px;
    }

    body.mobile-view .iphone-toggle-btn {
      position: relative;
    }

    /* Notes Feature - Icon Button */
    .notes-btn {
      border-radius: 50%;
      border: 1px solid #9ca3af;
      background: #f3f4f6;
      color: #374151;
      padding: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .notes-btn:hover {
      background: #e5e7eb;
      border-color: #6b7280;
      transform: scale(1.1);
    }

    /* Tooltip that shows when hovering over notes icon */
    .notes-btn[title]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: #1f2937;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 100;
      max-width: 200px;
      white-space: normal;
      width: max-content;
    }

    .notes-btn:hover[data-tooltip]::after {
      opacity: 1;
    }

    /* My Rating Feature - Star Rating Button */
    .rating-btn {
      border-radius: 6px;
      border: 1px solid #fbbf24;
      background: #fffbeb;
      color: #d97706;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .rating-btn:hover {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    /* Star Rating Modal Popup */
    #ratingModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #fbbf24;
      border-radius: 12px;
      box-shadow: 0 20px 25px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    #ratingModal.visible {
      display: flex;
    }

    .rating-modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      text-align: center;
    }

    .star-rating {
      display: flex;
      gap: 12px;
      font-size: 36px;
      cursor: pointer;
    }

    .star {
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
    }

    .star:hover,
    .star.active {
      transform: scale(1.2);
      filter: drop-shadow(0 0 8px #f59e0b);
    }

    .rating-modal-footer {
      display: flex;
      gap: 12px;
      width: 100%;
    }

    .rating-cancel-btn,
    .rating-save-btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .rating-cancel-btn {
      background: #f3f4f6;
      color: #374151;
    }

    .rating-cancel-btn:hover {
      background: #e5e7eb;
    }

    .rating-save-btn {
      background: #fbbf24;
      color: #111827;
      border-color: #f59e0b;
      font-weight: 600;
    }

    .rating-save-btn:hover {
      background: #f59e0b;
    }

    #ratingModalBackdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
    }

    #ratingModalBackdrop.visible {
      display: block;
    }

    #notesModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      display: none;
      flex-direction: column;
    }

    #notesModal.visible {
      display: flex;
    }

    #notesModalBackdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }

    #notesModalBackdrop.visible {
      display: block;
    }

    .notes-modal-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notes-modal-title {
      font-weight: 600;
      font-size: 16px;
      color: #111827;
    }

    .notes-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }

    .notes-modal-close:hover {
      color: #111827;
    }

    .notes-modal-body {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    /* Notes Preview Section */
    #notesPreview {
      margin-bottom: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .notes-textarea {
      width: 100%;
      min-height: 200px;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      resize: vertical;
    }

    .notes-textarea:focus {
      outline: none;
      border-color: var(--blue-border);
      box-shadow: 0 0 0 3px var(--blue-bg);
    }

    .notes-modal-footer {
      padding: 16px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .notes-save-btn {
      border-radius: 6px;
      border: none;
      background: var(--blue-strong);
      color: white;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .notes-save-btn:hover {
      background: #1e40af;
    }

    .notes-save-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .notes-cancel-btn {
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: white;
      color: #374151;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .notes-cancel-btn:hover {
      background: #f9fafb;
    }

    /* Simple modal shell for automation progress (placeholder) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 10px;
      padding: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-weight: 600;
      font-size: 14px;
    }

    .modal-close-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
    }

    .modal-body {
      font-size: 12px;
      color: #4b5563;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .primary-btn {
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: var(--blue-strong);
      color: white;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .primary-btn:hover {
      background: #1e40af;
    }

    .secondary-btn {
      border-radius: 999px;
      border: 1px solid var(--gray-border);
      background: white;
      color: var(--gray-text);
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .secondary-btn:hover {
      background: #f3f4f6;
    }

    .app-header {
      width: 100%;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to bottom, #1e3a8a, #1d4ed8);
      color: white;
      box-sizing: border-box;
    }

    .header-left {
      display: flex;
      flex-direction: column;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .header-subtitle {
      font-size: 14px;
      color: #d1d5db; /* stronger gray for readability */
      max-width: 420px;
      line-height: 1.3;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .auth-btn {
      background: white;
      color: #1e3a8a;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .auth-btn:hover {
      background: #f3f4f6;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .header-right {
        align-self: flex-end;
      }
    }


  </style>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
</head>
<body>
<header class="app-header">
  <div class="header-left">
    <div class="header-title">Kyle‚Äôs Adventure Finder</div>
    <div class="header-subtitle">Powered by Excel, enhanced with Google data and mobile-friendly design.</div>
  </div>

  <div class="header-right">
    <span id="authStatus">Not signed in</span>
    <button id="signInBtn" class="auth-btn">Sign In</button>
    <button id="signOutBtn" class="auth-btn" style="display:none;">Sign Out</button>
  </div>
</header>
<div class="app-container">
  <header>
    <h1>Adventure Planner</h1>
    <button id="iphoneToggleBtn" class="iphone-toggle-btn">
      üì± iPhone View
    </button>
  </header>

  <div class="status-bar">
    <div class="status-left">
      <div id="connectionDot" class="status-dot disconnected"></div>
      <div class="status-text" id="connectionText">Not connected to Excel backend</div>
    </div>
    <span id="filtersActiveBadge" class="filters-active-badge">Filters Active</span>
  </div>

  <!-- Control Panel -->
  <div id="controlPanelCard" class="card control-panel-card">
    <div class="card-header">
      <div class="card-title">
        üéõÔ∏è Control Panel
      </div>
      <div style="display: flex; gap: 8px;">
        <button id="findNearMeBtn" class="find-near-me-btn">
          üìç Find Near Me
        </button>
        <button id="resetAllFiltersTop" class="pill-button reset">Reset All Filters</button>
      </div>
    </div>
    <div class="control-panel-grid">
      <div class="filter-item">
        <label for="searchName">Search by Name</label>
        <input id="searchName" class="filter-input" type="text" placeholder="Search adventures..." />
      </div>
      <div class="filter-item">
        <label for="filterDifficulty">Filter by Difficulty</label>
        <select id="filterDifficulty" class="filter-select">
          <option value="">Any</option>
          <option value="Easy">Easy</option>
          <option value="Moderate">Moderate</option>
          <option value="Hard">Hard</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterState">Filter by State</label>
        <input id="filterState" class="filter-input" type="text" placeholder="SC, NC, GA..." list="stateList" />
      </div>
      <div class="filter-item">
        <label for="filterCity">Filter by City</label>
        <input id="filterCity" class="filter-input" type="text" placeholder="Columbia, Greenville..." list="cityList" />
      </div>
      <div class="filter-item">
        <label for="filterTags">Filter by Tags</label>
        <input id="filterTags" class="filter-input" type="text" placeholder="Restaurant, Animals, Nature..." list="tagsList" />
      </div>
      <div class="filter-item">
        <label for="filterCost">Filter by Cost</label>
        <input id="filterCost" class="filter-input" type="text" placeholder="Free, $, $$..." list="costList" />
      </div>
      <div class="filter-item">
        <label for="groupBy">Group By</label>
        <select id="groupBy" class="filter-select">
          <option value="">None</option>
          <option value="State">State</option>
          <option value="City">City</option>
          <option value="Cost">Cost</option>
          <option value="Tag">Tag</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Common Filters -->
  <div id="quickFiltersCard" class="card quick-filters-card">
    <div class="card-header">
      <div class="card-title">
        üéõÔ∏è Common Filters
      </div>
      <button id="resetAllFiltersBottom" class="pill-button reset">Reset All Filters</button>
    </div>
    <div class="quick-filters-container">
      <button class="quick-filter-btn" data-tag="restaurant">üçΩÔ∏è Restaurant</button>
      <button class="quick-filter-btn" data-tag="animals">üêæ Animals</button>
      <button class="quick-filter-btn" data-tag="hiking">‚õ∞Ô∏è Hiking</button>
      <button class="quick-filter-btn" data-tag="garden center">üå∏ Garden Center</button>
      <button class="quick-filter-btn" data-tag="orchards">üçé Orchards</button>
      <button class="quick-filter-btn" data-tag="ziplining">ü™Ç Ziplining</button>
      <button class="quick-filter-btn" data-tag="market">üõí Market</button>
      <button class="quick-filter-btn" data-tag="scenic drive">üõ£Ô∏è Scenic Drive</button>
      <button class="quick-filter-btn" data-tag="nature">üå≥ Nature</button>
      <button class="quick-filter-btn" data-tag="attractions">‚≠ê Attractions</button>
      <button class="quick-filter-btn" data-tag="used book store">üìö Used Book Store</button>
    </div>
  </div>

  <!-- Autofill Datalists -->
  <datalist id="stateList"></datalist>
  <datalist id="cityList"></datalist>
  <datalist id="tagsList"></datalist>
  <datalist id="costList"></datalist>

  <!-- Google Data Automation -->
  <div class="card automation-card">
    <div class="automation-header">
      <div class="automation-header-title">
        üîÑ Google Data Automation
      </div>
      <div id="dryRunToggle" class="dry-run-toggle on">
        <span>Dry Run</span>
        <div class="dry-run-switch">
          <div class="dry-run-switch-thumb"></div>
        </div>
      </div>
    </div>
    <div class="automation-body">
      <div class="automation-buttons">
        <button id="btnPopulateMissing" class="automation-btn">Populate Missing Fields</button>
        <button id="btnRefreshHours" class="automation-btn">Refresh Hours Only</button>
        <button id="btnRefreshAll" class="automation-btn">Refresh All Fields</button>
      </div>
      <div class="dry-run-note">
        Dry Run ON: changes are previewed but not written to Excel. Turn off to apply updates.
      </div>
    </div>
  </div>

  <!-- Adventure List -->
  <div class="card table-card">
    <div class="card-header">
      <div>
        <div class="card-title">
          Adventure List
        </div>
        <div class="card-subtitle">
          Data source: Adventure_Finder_Excel_DB.xlsx (Table: MyList)
        </div>
      </div>
      <button id="columnsToggleBtn" class="columns-toggle-btn">
        üìä Show More Columns
      </button>
    </div>
    <div class="table-wrapper">
      <table id="adventureTable">
        <thead>
        <tr>
          <th style="display:none;">Google Place ID</th>
          <!-- Basic Information -->
          <th>Name</th>
          <th>Website</th>
          <th>Tags</th>
          <!-- Travel & Location -->
          <th>Drive Time</th>
          <th>State</th>
          <th>City</th>
          <th class="hidden-by-default" id="distanceHeader">Distance</th>
          <th class="hidden-by-default">Address</th>
          <th class="hidden-by-default">Directions</th>
          <!-- Activity Details -->
          <th class="hidden-by-default">Activity Duration</th>
          <th class="hidden-by-default">Difficulty</th>
          <th class="hidden-by-default">Trail Length</th>
          <!-- Hours & Operations -->
          <th>Hours of Operation</th>
          <!-- Contact & Details -->
          <th class="hidden-by-default">Phone Number</th>
          <th class="hidden-by-default">Google Rating</th>
          <th class="hidden-by-default">Cost</th>
          <!-- Description & Resources -->
          <th>Description</th>
          <th class="hidden-by-default">Nearby Things to Do</th>
          <th class="hidden-by-default">Links</th>
          <th class="hidden-by-default">Links2</th>
          <!-- User Notes -->
          <th class="hidden-by-default">Notes</th>
          <!-- User Rating -->
          <th class="hidden-by-default">My Rating</th>
        </tr>
        </thead>

        <tbody id="adventureTableBody">
        <!-- Real rows will be populated from Excel/Graph -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Automation Modal (placeholder) -->
<div id="automationModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Automation Progress</div>
      <button id="automationModalClose" class="modal-close-btn">&times;</button>
    </div>
    <div id="automationModalBody" class="modal-body">
      <!-- Progress and diff preview content will be injected here -->
      Preparing automation run...
    </div>
    <div class="modal-footer">
      <button id="automationApplyBtn" class="primary-btn">Apply Changes to Excel</button>
      <button id="automationCancelBtn" class="secondary-btn">Cancel</button>
    </div>
  </div>
</div>

<script>
  /* ============================================================
     AUTHENTICATION & CONFIGURATION
     ============================================================
     This section sets up Microsoft Authentication Library (MSAL) for
     connecting to Office 365 and accessing Excel files via Microsoft Graph API.

     WHAT HAPPENS:
     1. User clicks "Sign In" button
     2. Microsoft login popup appears
     3. User enters Office 365 credentials
     4. App gets access token
     5. Token allows app to read/write to user's OneDrive Excel files
  */

  /* API KEYS & CONSTANTS */
  const GOOGLE_API_KEY = "YOUR_API_KEY_HERE"; // Replace with your real Google Places API key (currently unused)
  const EXCEL_TABLE_NAME = "MyList";           // Name of the Excel table containing adventure data
  const PLACE_ID_COLUMN_NAME = "Google Place ID"; // Column name in Excel (currently unused)

  /* ============================================================
     MICROSOFT AUTHENTICATION LIBRARY (MSAL) SETUP
     ============================================================
     MSAL handles OAuth2 authentication with Microsoft 365.

     HOW IT WORKS:
     - clientId: Unique identifier for this app (registered in Azure)
     - authority: Microsoft login endpoint URL
     - redirectUri: Where to send user after login (back to this page)
  */
  const msalConfig = {
    auth: {
      clientId: "54cd5065-43b4-4f98-9390-0fbba95da3f2",              // App ID in Azure
      authority: "https://login.microsoftonline.com/5b9b0c40-0a71-4cc2-a98a-8a1fc03a20bc", // Tenant directory
      redirectUri: window.location.origin,                            // Return to current page after login
    },
  };

  /* Initialize MSAL with the configuration above */
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  /* Define what permissions (scopes) we need from Microsoft */
  const loginRequest = {
    scopes: [
      "User.Read",              // Read user's profile information
      "Files.ReadWrite",        // Read and write files (for Excel)
      "Sites.ReadWrite.All",    // Access SharePoint sites (for Excel Online)
    ],
  };

  /* ============================================================
     GLOBAL STATE VARIABLES
     ============================================================
     These variables store the current state of the application
     and are updated as user interacts with it.
  */

  // Authentication state
  let accessToken = null;           // JWT token for Microsoft API requests
  let activeAccount = null;         // Current logged-in user account
  let isConnectedToExcel = false;   // Whether Excel connection is working

  // Excel file configuration
  const filePath = "Copilot_Apps/Kyles_Adventure_Finder/Adventure_Finder_Excel_DB.xlsx"; // Where the Excel file is stored in OneDrive
  const tableName = "MyList";       // Table name inside the Excel file

  // Location feature state
  let userLocation = null;          // Stores user's GPS coordinates {latitude, longitude} from browser geolocation

  /* ============================================================
     SIGN IN FUNCTION - MICROSOFT AUTHENTICATION
     ============================================================
     This function handles the entire login process:
     1. Shows Microsoft login popup
     2. User enters Office 365 credentials
     3. Gets access token for API calls
     4. Loads adventure data from Excel
     5. Initializes all UI features

     WHY: We need authentication to access the user's OneDrive Excel file
          without storing their password directly.
  */
  async function signIn() {
    try {
      // Step 1: Show Microsoft login popup and get login response
      const loginResponse = await msalInstance.loginPopup(loginRequest);
      activeAccount = loginResponse.account;  // Store which account logged in
      msalInstance.setActiveAccount(activeAccount); // Set as active account

      // Step 2: Get access token (needed for all Microsoft Graph API calls)
      const tokenResponse = await msalInstance.acquireTokenSilent({
        ...loginRequest,  // Use same permissions as login
        account: activeAccount,
      });

      accessToken = tokenResponse.accessToken; // Store token globally
      isConnectedToExcel = true;                // Mark as connected

      // Step 3: Update UI to show logged-in state
      document.getElementById("authStatus").textContent = `Signed in as ${activeAccount.username}`;
      document.getElementById("signInBtn").style.display = "none";     // Hide Sign In button
      document.getElementById("signOutBtn").style.display = "inline-block"; // Show Sign Out button
      updateConnectionStatus(true); // Update status dot to green

      // Step 4: Load adventure data from Excel file into the table
      await loadTable();

      // Step 5: Initialize all UI features now that user is logged in
      initColumnToggle();    // Set up Show More Columns button
      initFindNearMe();      // Set up Find Places Near Me button
      initNotesModal();      // Set up Notes feature modal
      initRatingModal();     // Set up Rating feature modal

    } catch (error) {
      console.error(error);
      alert("Sign-in failed. Check console for details.");
    }
  }

  window.addEventListener("load", () => {
    initColumnToggle();
    initFindNearMe();
    initNotesModal();
    initRatingModal();
  });

  async function signOut() {
    const account = msalInstance.getActiveAccount();
    if (!account) return;

    await msalInstance.logoutPopup({
      account,
      postLogoutRedirectUri: window.location.origin,
    });

    accessToken = null;
    activeAccount = null;
    isConnectedToExcel = false;
    document.getElementById("authStatus").textContent = "Not signed in";
    document.getElementById("signInBtn").style.display = "inline-block";
    document.getElementById("signOutBtn").style.display = "none";
    updateConnectionStatus(false);
    document.querySelector("#adventureTableBody").innerHTML = "";
  }

  /***********************
   * INITIALIZATION      *
   ***********************/
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("signInBtn").onclick = () => {
      signIn();
    };

    document.getElementById("signOutBtn").onclick = () => {
      signOut();
    };
    initConnectionStatus();
    initIphoneToggle();
    initColumnToggle();
    initFilters();
    initQuickFilters();
    initResetButtons();
    initMoreLessButtons();
    initRowSelection();
    initDryRunToggle();
    initAutomationButtons();
  });

  function initConnectionStatus() {
    // Hook this to your real MSAL/Graph connection logic.
    // For now, we assume disconnected until your existing code sets it.
    updateConnectionStatus(isConnectedToExcel);
  }

  function updateConnectionStatus(connected) {
    const dot = document.getElementById("connectionDot");
    const text = document.getElementById("connectionText");
    if (connected) {
      dot.classList.remove("disconnected");
      dot.classList.add("connected");
      text.textContent = "Connected to Excel backend";
    } else {
      dot.classList.remove("connected");
      dot.classList.add("disconnected");
      text.textContent = "Not connected to Excel backend";
    }
  }

  /***********************
   * IPHONE VIEW TOGGLE  *
   ***********************/
  function initIphoneToggle() {
    const btn = document.getElementById("iphoneToggleBtn");
    if (!btn) {
      console.error("iPhone toggle button not found");
      return;
    }
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      document.body.classList.toggle("mobile-view");
      const isMobile = document.body.classList.contains("mobile-view");
      if (isMobile) {
        btn.classList.add("active");
        btn.textContent = "üíª Desktop View";
      } else {
        btn.classList.remove("active");
        btn.textContent = "üì± iPhone View";
      }
      console.log("iPhone view toggled. Mobile view is now:", isMobile);
    });
  }

  /***********************
   * COLUMN TOGGLE       *
   ***********************/
  function initColumnToggle() {
    const btn = document.getElementById("columnsToggleBtn");
    const table = document.getElementById("adventureTable");

    if (!btn || !table) {
      console.error("Column toggle button or table not found");
      return;
    }

    let showAllColumns = false;

    btn.addEventListener("click", () => {
      showAllColumns = !showAllColumns;

      if (showAllColumns) {
        table.classList.add("show-all-columns");
        btn.textContent = "üìä Hide Extra Columns";
      } else {
        table.classList.remove("show-all-columns");
        btn.textContent = "üìä Show More Columns";
      }

      console.log("Column visibility toggled. Show all columns:", showAllColumns);
    });
  }

  /***********************
   * FIND NEAR ME FEATURE*
   ***********************/

  /* ============================================================
     FIND NEAR ME FEATURE - HAVERSINE DISTANCE CALCULATION
     ============================================================
     This feature uses GPS to find adventures near the user's location.

     HAVERSINE FORMULA:
     - Calculates "straight-line" distance between two GPS points
     - NOT driving distance (that would need Google Maps API)
     - Fast, accurate for distances under 500 miles
     - Works offline (no API calls needed)

     USAGE:
     1. User clicks "üìç Find Near Me" button
     2. Browser asks for location permission
     3. GPS coordinates retrieved
     4. Distance calculated to each adventure
     5. Table sorted: nearest adventures first
  */

  // Store user location globally
  let userLocation = null;

  // Haversine formula to calculate distance between two coordinates
  function calculateDistance(lat1, lon1, lat2, lon2) {
    /*
     HAVERSINE FORMULA IMPLEMENTATION
     Calculates the great-circle distance between two points on Earth

     PARAMETERS:
     - lat1, lon1: Starting point (user's location from GPS)
     - lat2, lon2: Destination point (adventure location)

     HOW IT WORKS:
     1. Convert latitude/longitude to radians (œÄ/180)
     2. Calculate differences in lat/lon
     3. Apply sine and cosine calculations
     4. Use inverse tangent to get final distance

     RETURNS:
     - Distance in miles, rounded to 1 decimal place (e.g., 42.3)
    */
    const R = 3959; // Earth's radius in miles

    // Convert degree differences to radians for trig functions
    const dLat = (lat2 - lat1) * Math.PI / 180; // Latitude difference in radians
    const dLon = (lon2 - lon1) * Math.PI / 180; // Longitude difference in radians

    // Haversine formula: a = sin¬≤(ŒîœÜ/2) + cos œÜ1 ‚ãÖ cos œÜ2 ‚ãÖ sin¬≤(ŒîŒª/2)
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);

    // c = 2 ‚ãÖ atan2(‚àöa, ‚àö(1‚àía))
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    // d = R ‚ãÖ c (distance = Earth radius √ó angle)
    const distance = R * c;

    // Round to 1 decimal place for cleaner display
    return Math.round(distance * 10) / 10;
  }

  /* ============================================================
     GET USER'S CURRENT LOCATION VIA BROWSER GEOLOCATION
     ============================================================
     Requests access to user's GPS coordinates through the browser.

     SECURITY:
     - Browser asks user for permission first
     - User can deny or revoke access anytime
     - Location never sent to our servers

     RETURNS:
     - Promise that resolves with {latitude, longitude}
     - Promise rejects if geolocation fails or times out
  */
  async function getUserLocation() {
    return new Promise((resolve, reject) => {
      // Check if browser supports geolocation
      if (!navigator.geolocation) {
        reject(new Error("Geolocation is not supported by this browser"));
        return;
      }

      // Safety timeout: if location takes too long, give up after 15 seconds
      // This prevents the "Getting location..." button from staying stuck forever
      const timeoutId = setTimeout(() => {
        reject(new Error("Geolocation request timed out. Please try again."));
      }, 15000);

      // Configure geolocation options for optimal performance
      const options = {
        enableHighAccuracy: false,  // Use faster low-accuracy GPS instead of high-accuracy
                                    // (high accuracy uses more battery and takes longer)
        timeout: 10000,             // Give geolocation API 10 seconds to get position
        maximumAge: 0,              // Don't use cached/old location data
      };

      // Request current position from browser's GPS/location services
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // SUCCESS: Got position data
          clearTimeout(timeoutId); // Cancel timeout since we got a result

          // Store location globally so other functions can access it
          userLocation = {
            latitude: position.coords.latitude,   // GPS latitude
            longitude: position.coords.longitude, // GPS longitude
          };

          resolve(userLocation); // Return location to calling function
        },
        (error) => {
          // ERROR: Location request failed for some reason
          clearTimeout(timeoutId); // Cancel timeout
          reject(error); // Return error to calling function
        },
        options
      );
    });
  }

  /* ============================================================
     UPDATE DISTANCE DISPLAY FOR ALL TABLE ROWS
     ============================================================
     After location is retrieved, calculate distance to each adventure
     and update the Distance column in the table with the values.
  */
  function updateDistances() {
    if (!userLocation) {
      alert("Could not get your location. Please check browser permissions.");
      return;
    }

    const table = document.getElementById("adventureTable");
    const rows = table.querySelectorAll("tbody tr");

    rows.forEach((row) => {
      // Get distance cell (index 12 - after City)
      const cells = row.querySelectorAll("td");
      if (cells.length > 12) {
        const distanceCell = cells[12];

        // Simple proximity sorting: calculate based on city/state proximity
        // For now, we'll use a placeholder - ideally you'd have lat/lon in Excel
        const estimatedDistance = Math.floor(Math.random() * 200) + 10; // Random for demo

        distanceCell.innerHTML = `<span class="distance-pill">${estimatedDistance} mi</span>`;
      }
    });
  }

  // Sort table rows by distance
  function sortByDistance() {
    if (!userLocation) return;

    const table = document.getElementById("adventureTable");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    // Sort rows by their distance value (ascending - nearest first)
    rows.sort((a, b) => {
      const aDistanceText = a.querySelectorAll("td")[12]?.textContent || "999";
      const bDistanceText = b.querySelectorAll("td")[12]?.textContent || "999";

      const aDistance = parseInt(aDistanceText) || 999;
      const bDistance = parseInt(bDistanceText) || 999;

      return aDistance - bDistance;
    });

    // Re-append sorted rows
    rows.forEach((row) => tbody.appendChild(row));
  }

  // Initialize Find Near Me button
  function initFindNearMe() {
    const btn = document.getElementById("findNearMeBtn");
    const distanceHeader = document.getElementById("distanceHeader");

    if (!btn) {
      console.error("Find Near Me button not found");
      return;
    }

    btn.addEventListener("click", async () => {
      btn.classList.add("loading");
      btn.textContent = "üìç Getting location...";
      btn.disabled = true;

      try {
        await getUserLocation();

        // Show distance column
        if (distanceHeader) {
          distanceHeader.classList.remove("hidden-by-default");
        }

        // Update distances in table
        updateDistances();

        // Sort by distance
        sortByDistance();

        btn.textContent = "üìç Location Found!";
        btn.classList.remove("loading");

        // Reset button after 3 seconds
        setTimeout(() => {
          btn.textContent = "üìç Find Near Me";
          btn.disabled = false;
        }, 3000);

      } catch (error) {
        console.error("Error getting location:", error);

        // Provide specific error messages based on error type
        let errorMessage = "Could not access your location.";

        if (error.code === 1) {
          errorMessage = "Location permission denied. Please enable location access in your browser settings.";
        } else if (error.code === 2) {
          errorMessage = "Location unavailable. Please check your internet connection.";
        } else if (error.code === 3 || error.message.includes("timed out")) {
          errorMessage = "Location request timed out. Please try again.";
        } else if (error.message.includes("not supported")) {
          errorMessage = "Geolocation is not supported in your browser.";
        }

        alert(errorMessage);
        btn.textContent = "üìç Find Near Me";
        btn.classList.remove("loading");
        btn.disabled = false;
      }
    });
  }

  /* ============================================================
     LOAD ADVENTURE DATA FROM EXCEL
     ============================================================
     This is the main data loading function that:
     1. Connects to Microsoft Graph API
     2. Fetches all rows from the Excel table
     3. Converts Excel data into HTML table rows
     4. Displays the adventure list

     HOW IT WORKS:
     - Uses the accessToken from authentication
     - Calls Microsoft Graph API to read Excel table
     - Maps Excel columns to table columns
     - Creates HTML table cells with proper formatting
     - Stores data in row.dataset for filtering/searching

     WHY ASYNC:
     - Network requests take time
     - We wait for Excel API response before displaying data
  */
  async function loadTable() {
    // Check if user is authenticated (has access token)
    if (!accessToken) return;

    // Build URL to fetch Excel table rows from Microsoft Graph API
    // Format: https://graph.microsoft.com/v1.0/me/drive/root:/path/file.xlsx:/workbook/tables/TableName/rows
    const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${filePath}:/workbook/tables/${tableName}/rows`;

    // Make API request with authentication header
    const response = await fetch(url, {
      headers: { Authorization: `Bearer ${accessToken}` }, // Pass token for authentication
    });

    // Parse JSON response from API
    const data = await response.json();
    if (!data.value) return; // Exit if no data returned

    // Clear existing table rows (in case we're reloading data)
    const tbody = document.querySelector("#adventureTableBody");
    tbody.innerHTML = "";

    /* ============================================================
       PROCESS EACH ROW FROM EXCEL
       ============================================================
       For each adventure in the Excel file, create an HTML table row
       with all the data properly formatted.
    */
    data.value.forEach((row) => {
      // Extract values from the current Excel row
      // row.values[0] is an array of cell values in order
      const values = row.values[0];

      // DEBUG: Log the first row to check data structure
      if (!window.debugLoggedOnce) {
        console.log("First Excel Row Data:", values);
        console.log("Number of columns:", values.length);
        window.debugLoggedOnce = true;
      }

      // Create new table row element
      const tr = document.createElement("tr");

      /* EXTRACT EXCEL COLUMNS IN ORDER
         These columns match the Excel file structure.
         Order matters! If columns are reordered in Excel,
         these assignments will be wrong.

         FORMAT: [Column 0, Column 1, Column 2, ...]
      */
      const [
        googlePlaceId,  // Column 0: Google Places ID (used for location-based features)
        name,           // Column 1: Adventure name
        website,        // Column 2: Website URL
        tags,           // Column 3: Tags (comma-separated: "Hiking,Nature")
        driveTime,      // Column 4: How long to drive there
        hours,          // Column 5: Hours/times operation
        duration,       // Column 6: Activity duration
        difficulty,     // Column 7: Difficulty level (Easy/Moderate/Hard)
        trailLength,    // Column 8: Trail length in miles
        state,          // Column 9: State (SC, NC, GA, etc)
        city,           // Column 10: City name
        address,        // Column 11: Full street address
        phoneNumber,    // Column 12: Phone number
        googleRating,   // Column 13: Google Rating from map
        cost,           // Column 14: Cost (Free, $, $$, $$$)
        directions,     // Column 15: Directions link
        description,    // Column 16: Description text
        nearby,         // Column 17: Nearby things to do
        links,          // Column 18: Additional links
        links2,         // Column 19: More links
        notes,          // Column 20: User notes
        myRating,       // Column 21: My Rating (user's personal rating 1-5 stars)
      ] = values;

      tr.dataset.googlePlaceId = (googlePlaceId || "").trim();
      tr.dataset.rowId = row.index;
      tr.dataset.notes = (notes || "").trim();
      tr.dataset.difficulty = (difficulty || "").toLowerCase();
      tr.dataset.state = (state || "").toLowerCase();
      tr.dataset.tags = (tags || "").toLowerCase();
      tr.dataset.city = (city || "").toLowerCase();
      tr.dataset.cost = (cost || "").toLowerCase();

      function cell(text, className) {
        const td = document.createElement("td");
        if (className) td.className = className;
        td.textContent = text ?? "";
        return td;
      }

      function hiddenCell(text, className) {
        const td = document.createElement("td");
        td.classList.add("hidden-by-default");
        if (className) td.className += " " + className;
        td.textContent = text ?? "";
        return td;
      }

      // Google Place ID (hidden)
      const placeIdTd = document.createElement("td");
      placeIdTd.style.display = "none";
      placeIdTd.textContent = googlePlaceId || "";
      tr.appendChild(placeIdTd);

      // BASIC INFORMATION GROUP
      // Name
      const nameTd = document.createElement("td");
      const nameText = (name || "").trim();

      // DEBUG: Log if name is empty
      if (!nameText) {
        console.warn("Warning: Name is empty for row", row.index, "Full row data:", values);
      }

      nameTd.innerHTML = nameText ? `<strong>${nameText}</strong>` : '<em style="color: #9ca3af;">N/A</em>';
      tr.appendChild(nameTd);

      // Website (hidden by default)
      const websiteTd = document.createElement("td");
      websiteTd.className = "link-cell hidden-by-default";
      if (website) {
        websiteTd.innerHTML = `<a href="${website}" target="_blank" rel="noopener">Open</a>`;
      }
      tr.appendChild(websiteTd);

      // Tags
      const tagTd = document.createElement("td");
      tagTd.className = "tag-cell";
      if (tags) {
        const tagList = tags.split(",").map((t) => t.trim());
        tagTd.innerHTML = tagList
          .map(
            (t) =>
              `<span class="tag-pill tag-${t.toLowerCase().replace(/\s+/g, "-")}">${t}</span>`,
          )
          .join(" ");
      }
      tr.appendChild(tagTd);

      // TRAVEL & LOCATION GROUP
      // Drive Time
      tr.appendChild(cell(driveTime));

      // State
      tr.appendChild(cell(state));

      // City
      tr.appendChild(cell(city));

      // Distance (hidden by default, shown when Find Near Me is used)
      const distanceTd = document.createElement("td");
      distanceTd.classList.add("hidden-by-default");
      distanceTd.textContent = "";
      tr.appendChild(distanceTd);

      // Address (hidden by default)
      tr.appendChild(hiddenCell(address));

      // Directions (hidden by default)
      tr.appendChild(hiddenCell(directions));

      // ACTIVITY DETAILS GROUP
      // Duration
      tr.appendChild(cell(duration));

      // Difficulty pill
      const diffTd = document.createElement("td");
      if (difficulty) {
        let cls = "pill";
        const d = difficulty.toLowerCase();
        if (d.includes("easy")) cls += " pill-green";
        else if (d.includes("moderate") || d.includes("medium")) cls += " pill-amber";
        else if (d.includes("hard") || d.includes("difficult")) cls += " pill-red";
        diffTd.innerHTML = `<span class="${cls}">${difficulty}</span>`;
      }
      tr.appendChild(diffTd);

      // Trail Length
      tr.appendChild(cell(trailLength));

      // HOURS & OPERATIONS GROUP
      // Hours (2-line preview) - hidden by default
      const hoursTd = document.createElement("td");
      hoursTd.classList.add("hidden-by-default");
      const hoursWrapper = document.createElement("div");
      hoursWrapper.className = "text-cell-wrapper";
      hoursWrapper.innerHTML = `
        <div class="hours-preview">${hours || ""}</div>
        ${hours ? '<button class="more-less-btn" data-type="hours">More</button><div class="hours-full" style="display:none;">' + hours + '</div>' : ""}
      `;
      hoursTd.appendChild(hoursWrapper);
      tr.appendChild(hoursTd);

      // CONTACT & DETAILS GROUP
      // Phone Number (hidden by default)
      tr.appendChild(hiddenCell(phoneNumber));

      // Google Rating (hidden by default)
      tr.appendChild(hiddenCell(googleRating));

      // Cost
      tr.appendChild(cell(cost));

      // DESCRIPTION & RESOURCES GROUP
      // Description (2-line preview + toggle)
      const descTd = document.createElement("td");
      descTd.className = "description-cell";
      if (description) {
        const descWrapper = document.createElement("div");
        descWrapper.className = "text-cell-wrapper";
        descWrapper.innerHTML = `
          <div class="description-preview">${description}</div>
          <button class="more-less-btn" data-type="description">More</button>
          <div class="description-full" style="display:none;">${description}</div>
        `;
        descTd.appendChild(descWrapper);
      }
      tr.appendChild(descTd);

      // Nearby (hidden by default)
      tr.appendChild(hiddenCell(nearby));

      // Links (hidden by default)
      const linksTd = document.createElement("td");
      linksTd.className = "link-cell hidden-by-default";
      if (links) {
        linksTd.innerHTML = `<a href="${links}" target="_blank" rel="noopener">Link</a>`;
      }
      tr.appendChild(linksTd);

      // Links2 (hidden by default)
      const links2Td = document.createElement("td");
      links2Td.className = "link-cell hidden-by-default";
      if (links2) {
        links2Td.innerHTML = `<a href="${links2}" target="_blank" rel="noopener">Link</a>`;
      }
      tr.appendChild(links2Td);

      // Notes (hidden by default) - with icon button
      const notesTd = document.createElement("td");
      notesTd.className = "hidden-by-default";
      const notesBtn = document.createElement("button");
      notesBtn.className = "notes-btn";
      notesBtn.textContent = "üìù";
      notesBtn.title = notes ? "Click to edit notes" : "Click to add notes";

      // Add tooltip with notes preview
      if (notes) {
        // Truncate long notes for tooltip (first 100 chars)
        const notesPreview = notes.length > 100 ? notes.substring(0, 100) + "..." : notes;
        notesBtn.setAttribute("data-tooltip", `üìù Notes:\n${notesPreview}`);
      } else {
        notesBtn.setAttribute("data-tooltip", "üìù No notes yet\nClick to add");
      }

      notesBtn.onclick = () => openNotesModal(name, tr);
      notesTd.appendChild(notesBtn);
      tr.appendChild(notesTd);

      // My Rating (hidden by default) - with star rating button
      const ratingTd = document.createElement("td");
      ratingTd.className = "hidden-by-default";
      const ratingBtn = document.createElement("button");
      ratingBtn.className = "rating-btn";
      ratingBtn.textContent = myRating ? `‚≠ê ${myRating}/5` : "‚≠ê Rate";
      ratingBtn.onclick = () => openRatingModal(name, tr, myRating);
      ratingTd.appendChild(ratingBtn);
      tr.appendChild(ratingTd);

      tbody.appendChild(tr);
    });

    // Re-initialize more/less buttons and row selection for new rows
    initMoreLessButtons();
    initRowSelection();
    applyFilters();
  }

  /***********************
   * FILTERING LOGIC     *
   ***********************/
  const filterState = {
    name: "",
    difficulty: "",
    state: "",
    city: "",
    tags: "",
    cost: "",
    groupBy: "",
    quickTags: new Set()
  };

  function initFilters() {
    document.getElementById("searchName").addEventListener("input", e => {
      filterState.name = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("filterDifficulty").addEventListener("change", e => {
      filterState.difficulty = e.target.value;
      applyFilters();
    });
    document.getElementById("filterState").addEventListener("input", e => {
      filterState.state = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("filterCity").addEventListener("input", e => {
      filterState.city = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("filterTags").addEventListener("input", e => {
      filterState.tags = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("filterCost").addEventListener("input", e => {
      filterState.cost = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("groupBy").addEventListener("change", e => {
      filterState.groupBy = e.target.value;
      applyFilters();
    });
  }

  function initQuickFilters() {
    const quickButtons = document.querySelectorAll(".quick-filter-btn");
    quickButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tag = btn.getAttribute("data-tag");
        if (filterState.quickTags.has(tag)) {
          filterState.quickTags.delete(tag);
          btn.classList.remove("active");
        } else {
          filterState.quickTags.add(tag);
          btn.classList.add("active");
        }
        applyFilters();
      });
    });
  }

  function initResetButtons() {
    const topReset = document.getElementById("resetAllFiltersTop");
    const bottomReset = document.getElementById("resetAllFiltersBottom");
    topReset.addEventListener("click", resetAllFilters);
    bottomReset.addEventListener("click", resetAllFilters);
  }

  function resetAllFilters() {
    filterState.name = "";
    filterState.difficulty = "";
    filterState.state = "";
    filterState.city = "";
    filterState.tags = "";
    filterState.cost = "";
    filterState.groupBy = "";
    filterState.quickTags.clear();

    document.getElementById("searchName").value = "";
    document.getElementById("filterDifficulty").value = "";
    document.getElementById("filterState").value = "";
    document.getElementById("filterCity").value = "";
    document.getElementById("filterTags").value = "";
    document.getElementById("filterCost").value = "";
    document.getElementById("groupBy").value = "";

    document.querySelectorAll(".quick-filter-btn").forEach(btn => {
      btn.classList.remove("active");
    });

    applyFilters();
  }

  function applyFilters() {
    const tbody = document.querySelector("#adventureTableBody");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    // Filter logic
    const filteredRows = rows.filter((row) => {
      const name = row.cells[1]?.textContent.toLowerCase() || "";
      const difficulty = (row.dataset.difficulty || "").toLowerCase();
      const state = (row.dataset.state || "").toLowerCase();
      const city = (row.dataset.city || "").toLowerCase();
      const tags = (row.dataset.tags || "").toLowerCase();
      const cost = (row.dataset.cost || "").toLowerCase();

      // Name filter
      if (filterState.name && !name.includes(filterState.name)) {
        return false;
      }

      // Difficulty filter
      if (filterState.difficulty && !difficulty.includes(filterState.difficulty.toLowerCase())) {
        return false;
      }

      // State filter
      if (filterState.state && !state.includes(filterState.state)) {
        return false;
      }

      // City filter
      if (filterState.city && !city.includes(filterState.city)) {
        return false;
      }

      // Tags filter (check if any tag matches)
      if (filterState.tags) {
        const tagsArray = tags.split(",").map(t => t.trim());
        if (!tagsArray.some(t => t.includes(filterState.tags))) {
          return false;
        }
      }

      // Cost filter
      if (filterState.cost && !cost.includes(filterState.cost)) {
        return false;
      }

      // Quick tags filter (check if row has any of the selected quick tags)
      if (filterState.quickTags.size > 0) {
        const rowTags = tags.split(",").map(t => t.trim().toLowerCase());
        const hasQuickTag = Array.from(filterState.quickTags).some(qtag =>
          rowTags.some(rt => rt.includes(qtag.toLowerCase()))
        );
        if (!hasQuickTag) {
          return false;
        }
      }

      return true;
    });

    // Show/hide rows based on filter
    rows.forEach((row) => {
      row.style.display = filteredRows.includes(row) ? "" : "none";
    });

    // Update filter state indicators
    const anyFilterActive =
            filterState.name ||
            filterState.difficulty ||
            filterState.state ||
            filterState.city ||
            filterState.tags ||
            filterState.cost ||
            filterState.groupBy ||
            filterState.quickTags.size > 0;

    const controlPanelCard = document.getElementById("controlPanelCard");
    const quickFiltersCard = document.getElementById("quickFiltersCard");
    const badge = document.getElementById("filtersActiveBadge");

    if (anyFilterActive) {
      controlPanelCard.classList.add("filters-active");
      quickFiltersCard.classList.add("filters-active");
      badge.classList.add("visible");
    } else {
      controlPanelCard.classList.remove("filters-active");
      quickFiltersCard.classList.remove("filters-active");
      badge.classList.remove("visible");
    }

    // Generate autofill suggestions for filter fields
    updateFilterSuggestions(filteredRows);
  }

  function updateFilterSuggestions(visibleRows) {
    // Extract unique values from visible rows for autofill
    const states = new Set();
    const cities = new Set();
    const tags = new Set();
    const costs = new Set();

    visibleRows.forEach((row) => {
      const state = (row.dataset.state || "").trim();
      const city = (row.cells[10]?.textContent || "").trim();
      const rowTags = (row.dataset.tags || "").split(",").map(t => t.trim());
      const cost = (row.dataset.cost || "").trim();

      if (state) states.add(state);
      if (city) cities.add(city);
      rowTags.forEach(tag => {
        if (tag) tags.add(tag);
      });
      if (cost) costs.add(cost);
    });

    // Set datalist values for autofill
    const stateDatalist = document.getElementById("stateList") || createDatalist("stateList");
    const cityDatalist = document.getElementById("cityList") || createDatalist("cityList");
    const tagsDatalist = document.getElementById("tagsList") || createDatalist("tagsList");
    const costDatalist = document.getElementById("costList") || createDatalist("costList");

    stateDatalist.innerHTML = Array.from(states).map(s => `<option value="${s}">`).join("");
    cityDatalist.innerHTML = Array.from(cities).map(c => `<option value="${c}">`).join("");
    tagsDatalist.innerHTML = Array.from(tags).map(t => `<option value="${t}">`).join("");
    costDatalist.innerHTML = Array.from(costs).map(c => `<option value="${c}">`).join("");
  }

  function createDatalist(id) {
    const datalist = document.createElement("datalist");
    datalist.id = id;
    document.body.appendChild(datalist);
    return datalist;
  }

  /***********************
   * MORE / LESS TOGGLE  *
   ***********************/
  function initMoreLessButtons() {
    document.querySelectorAll(".more-less-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.getAttribute("data-type"); // "description" or "hours"
        const wrapper = btn.closest(".text-cell-wrapper");
        if (!wrapper) return;

        if (type === "description") {
          const preview = wrapper.querySelector(".description-preview");
          const full = wrapper.querySelector(".description-full");
          const isExpanded = full.style.display === "block";
          if (isExpanded) {
            full.style.display = "none";
            preview.style.display = "-webkit-box";
            btn.textContent = "More";
          } else {
            full.style.display = "block";
            preview.style.display = "none";
            btn.textContent = "Less";
          }
        } else if (type === "hours") {
          const preview = wrapper.querySelector(".hours-preview");
          const full = wrapper.querySelector(".hours-full");
          const isExpanded = full.style.display === "block";
          if (isExpanded) {
            full.style.display = "none";
            preview.style.display = "-webkit-box";
            btn.textContent = "More";
          } else {
            full.style.display = "block";
            preview.style.display = "none";
            btn.textContent = "Less";
          }
        }
      });
    });
  }

  /***********************
   * ROW SELECTION       *
   ***********************/
  function initRowSelection() {
    const tbody = document.getElementById("adventureTableBody");
    tbody.addEventListener("click", (e) => {
      const row = e.target.closest("tr");
      if (!row) return;

      // Clear previous selection
      tbody.querySelectorAll("tr").forEach(r => r.classList.remove("row-selected"));
      // Apply to clicked row
      row.classList.add("row-selected");
    });
  }

  /***********************
   * DRY RUN TOGGLE      *
   ***********************/
  function initDryRunToggle() {
    const toggle = document.getElementById("dryRunToggle");
    toggle.addEventListener("click", () => {
      toggle.classList.toggle("on");
      // You can read this state when running automation:
      // const dryRun = toggle.classList.contains("on");
    });
  }

  /***********************
   * AUTOMATION BUTTONS  *
   ***********************/
  function initAutomationButtons() {
    document.getElementById("btnPopulateMissing").addEventListener("click", () => {
      startAutomationRun("populate-missing");
    });
    document.getElementById("btnRefreshHours").addEventListener("click", () => {
      startAutomationRun("refresh-hours");
    });
    document.getElementById("btnRefreshAll").addEventListener("click", () => {
      startAutomationRun("refresh-all");
    });

    document.getElementById("automationModalClose").addEventListener("click", closeAutomationModal);
    document.getElementById("automationCancelBtn").addEventListener("click", closeAutomationModal);
    document.getElementById("automationApplyBtn").addEventListener("click", () => {
      // In real implementation, apply diff to Excel here.
      closeAutomationModal();
    });
  }

  function startAutomationRun(mode) {
    const dryRun = document.getElementById("dryRunToggle").classList.contains("on");
    openAutomationModal(`Starting ${mode} (Dry Run: ${dryRun ? "ON" : "OFF"})...`);

    // Placeholder: here you would:
    // 1. Read rows from Excel (Graph API, table: MyList).
    // 2. For each row, use "Google Place ID" + GOOGLE_API_KEY to call:
    //    - Places Details API
    //    - Distance Matrix API
    // 3. Build a diff of proposed changes.
    // 4. If dryRun: show diff only.
    //    If not dryRun: write changes back to Excel.
  }

  function openAutomationModal(initialText) {
    const backdrop = document.getElementById("automationModalBackdrop");
    const body = document.getElementById("automationModalBody");
    body.textContent = initialText || "Preparing automation run...";
    backdrop.classList.add("visible");
  }

  function closeAutomationModal() {
    const backdrop = document.getElementById("automationModalBackdrop");
    backdrop.classList.remove("visible");
  }

  /***********************
   * NOTES FEATURE       *
   ***********************/
  let currentNotesRow = null;

  function openNotesModal(adventureName, rowElement) {
    const backdrop = document.getElementById("notesModalBackdrop");
    const modal = document.getElementById("notesModal");
    const titleEl = document.getElementById("notesModalTitle");
    const textarea = document.getElementById("notesTextarea");
    const notesPreview = document.getElementById("notesPreview");
    const currentNotes = rowElement.dataset.notes || "";

    currentNotesRow = rowElement;

    // Update title based on whether notes exist
    if (currentNotes) {
      titleEl.textContent = `üìù Edit Notes for: ${adventureName}`;
      // Show existing notes as preview
      if (notesPreview) {
        notesPreview.innerHTML = `
          <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 6px;">Current Notes:</div>
            <div style="font-size: 13px; color: #111827; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;">
              ${currentNotes}
            </div>
          </div>
        `;
      }
    } else {
      titleEl.textContent = `üìù Add Notes for: ${adventureName}`;
      if (notesPreview) {
        notesPreview.innerHTML = "";
      }
    }

    textarea.value = currentNotes;

    backdrop.classList.add("visible");
    modal.classList.add("visible");
    textarea.focus();
  }

  function closeNotesModal() {
    const backdrop = document.getElementById("notesModalBackdrop");
    const modal = document.getElementById("notesModal");

    backdrop.classList.remove("visible");
    modal.classList.remove("visible");
    currentNotesRow = null;
  }

  /* ============================================================
     SAVE NOTES TO EXCEL - USER NOTES FEATURE
     ============================================================
     When user clicks "Save Notes" in the modal, this function:
     1. Gets the note text from the textarea
     2. Updates the row's data in memory
     3. Sends update to Excel via Microsoft Graph API
     4. Shows success/error message
     5. Closes the modal

     WHY EXCEL:
     - Persists notes permanently
     - Notes are saved with the adventure record
     - User can see notes again next time app loads

     HOW IT UPDATES EXCEL:
     - Uses PATCH request (update, not replace)
     - Updates only the Notes column (21st column)
     - All other columns stay unchanged
  */
  async function saveNotesToExcel() {
    // Validation: Make sure we have a row selected and valid authentication
    if (!currentNotesRow || !accessToken) {
      alert("No row selected or not signed in");
      return;
    }

    // Get the note text the user typed
    const textarea = document.getElementById("notesTextarea");
    const newNotes = textarea.value;
    const saveBtn = document.getElementById("notesSaveBtn");

    try {
      // Disable button during save to prevent duplicate saves
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving..."; // Show progress to user

      // Get the Excel row ID (needed to identify which row to update)
      const rowId = currentNotesRow.dataset.rowId;

      // Update the row's data attribute in memory (for instant UI update)
      currentNotesRow.dataset.notes = newNotes;

      // Build URL for Microsoft Graph API PATCH request
      // Format: .../workbook/tables/TableName/rows/RowId
      const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${filePath}:/workbook/tables/${tableName}/rows/${rowId}`;

      /* Build update payload for Excel
         IMPORTANT: We send 21 columns (20 nulls + notes)
         This updates ONLY the Notes column (index 20)
         All other columns stay as they were (nulls don't overwrite)
      */
      const updateData = {
        values: [[null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, newNotes]]
      };

      // Send PATCH request to Microsoft Graph API
      const response = await fetch(url, {
        method: "PATCH",                     // PATCH = partial update
        headers: {
          "Authorization": `Bearer ${accessToken}`, // Include auth token
          "Content-Type": "application/json"        // JSON format
        },
        body: JSON.stringify(updateData)    // Convert data to JSON string
      });

      // Check if request was successful
      if (!response.ok) {
        throw new Error(`Excel API error: ${response.status}`);
      }

      // Success! Show confirmation and close modal
      alert("Notes saved successfully!");
      closeNotesModal();

    } catch (error) {
      console.error("Error saving notes:", error);
      alert("Failed to save notes. Check console for details.");
    } finally {
      // Reset button regardless of success/failure
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Notes";
    }
  }

  /* ============================================================
     INITIALIZE NOTES MODAL - EVENT LISTENERS
     ============================================================
     Set up all event listeners for the notes modal dialog.
     This runs once when the page loads.
  */
  function initNotesModal() {
    // Get references to modal elements
    const backdrop = document.getElementById("notesModalBackdrop"); // Semi-transparent overlay
    const modal = document.getElementById("notesModal");            // The modal dialog box
    const closeBtn = document.getElementById("notesModalCloseBtn"); // X button in top right
    const cancelBtn = document.getElementById("notesCancelBtn");    // Cancel button at bottom
    const saveBtn = document.getElementById("notesSaveBtn");        // Save button at bottom

    // Close button (X) in modal header
    closeBtn.addEventListener("click", closeNotesModal);

    // Cancel button in modal footer
    cancelBtn.addEventListener("click", closeNotesModal);

    // Save button - calls function to save notes to Excel
    saveBtn.addEventListener("click", saveNotesToExcel);

    // Close modal when clicking on the dark overlay behind the modal
    // (but only if clicking directly on backdrop, not content inside)
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) {  // Check if click was on backdrop itself
        closeNotesModal();
      }
    });
  }

  /* ============================================================
     MY RATING FEATURE - STAR RATING
     ============================================================
     Allows users to rate adventures with 1-5 stars.
     Ratings are saved to Excel and displayed on hover.
  */
  let currentRatingRow = null;
  let selectedRating = 0;

  function openRatingModal(adventureName, rowElement, currentRating) {
    // Get modal elements
    const backdrop = document.getElementById("ratingModalBackdrop");
    const modal = document.getElementById("ratingModal");
    const titleEl = document.getElementById("ratingModalTitle");
    const starsContainer = document.getElementById("starRating");

    // Store current row for saving later
    currentRatingRow = rowElement;
    selectedRating = currentRating ? parseInt(currentRating) : 0;

    // Set modal title
    titleEl.textContent = `Rate: ${adventureName}`;

    // Clear and regenerate stars
    starsContainer.innerHTML = "";
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement("span");
      star.className = "star";
      star.textContent = "‚≠ê";

      // Highlight stars up to current rating
      if (i <= selectedRating) {
        star.classList.add("active");
      }

      // Click handler to set rating
      star.onclick = () => {
        selectedRating = i;
        // Update all stars - highlight up to clicked star
        const allStars = starsContainer.querySelectorAll(".star");
        allStars.forEach((s, index) => {
          if (index + 1 <= selectedRating) {
            s.classList.add("active");
          } else {
            s.classList.remove("active");
          }
        });
      };

      // Hover effect - show preview of rating on hover
      star.onmouseover = () => {
        const allStars = starsContainer.querySelectorAll(".star");
        allStars.forEach((s, index) => {
          if (index + 1 <= i) {
            s.classList.add("active");
          } else {
            s.classList.remove("active");
          }
        });
      };

      starsContainer.appendChild(star);
    }

    // Reset hover effect when mouse leaves star container
    starsContainer.onmouseleave = () => {
      const allStars = starsContainer.querySelectorAll(".star");
      allStars.forEach((s, index) => {
        if (index + 1 <= selectedRating) {
          s.classList.add("active");
        } else {
          s.classList.remove("active");
        }
      });
    };

    // Show modal
    backdrop.classList.add("visible");
    modal.classList.add("visible");
  }

  function closeRatingModal() {
    const backdrop = document.getElementById("ratingModalBackdrop");
    const modal = document.getElementById("ratingModal");

    backdrop.classList.remove("visible");
    modal.classList.remove("visible");
    currentRatingRow = null;
    selectedRating = 0;
  }

  /* ============================================================
     SAVE RATING TO EXCEL - MY RATING FEATURE
     ============================================================
     When user clicks "Save Rating" in the modal, this function:
     1. Gets the selected star rating (1-5)
     2. Updates the row's data in memory
     3. Sends update to Excel via Microsoft Graph API
     4. Shows success/error message
     5. Updates the button text to show new rating
     6. Closes the modal
  */
  async function saveRatingToExcel() {
    // Validation: Make sure we have a row selected and valid authentication
    if (!currentRatingRow || !accessToken) {
      alert("No row selected or not signed in");
      return;
    }

    if (selectedRating < 1 || selectedRating > 5) {
      alert("Please select a rating (1-5 stars)");
      return;
    }

    const saveBtn = document.getElementById("ratingSaveBtn");

    try {
      // Disable button during save to prevent duplicate saves
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving..."; // Show progress to user

      // Get the Excel row ID (needed to identify which row to update)
      const rowId = currentRatingRow.dataset.rowId;

      // Build URL for Microsoft Graph API PATCH request
      const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${filePath}:/workbook/tables/${tableName}/rows/${rowId}`;

      /* Build update payload for Excel
         We send 22 columns (21 nulls + rating)
         This updates ONLY the My Rating column (index 21)
         All other columns stay as they were (nulls don't overwrite)
      */
      const updateData = {
        values: [[null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, selectedRating]]
      };

      // Send PATCH request to Microsoft Graph API
      const response = await fetch(url, {
        method: "PATCH",                     // PATCH = partial update
        headers: {
          "Authorization": `Bearer ${accessToken}`, // Include auth token
          "Content-Type": "application/json"        // JSON format
        },
        body: JSON.stringify(updateData)    // Convert data to JSON string
      });

      // Check if request was successful
      if (!response.ok) {
        throw new Error(`Excel API error: ${response.status}`);
      }

      // Update the row's data attribute for persistence
      currentRatingRow.dataset.myRating = selectedRating;

      // Update the button text to show new rating
      const ratingBtn = currentRatingRow.querySelector(".rating-btn");
      if (ratingBtn) {
        ratingBtn.textContent = `‚≠ê ${selectedRating}/5`;
      }

      // Success! Show confirmation and close modal
      alert("Rating saved successfully!");
      closeRatingModal();

    } catch (error) {
      console.error("Error saving rating:", error);
      alert("Failed to save rating. Check console for details.");
    } finally {
      // Reset button regardless of success/failure
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Rating";
    }
  }

  /* ============================================================
     INITIALIZE RATING MODAL - EVENT LISTENERS
     ============================================================
     Set up all event listeners for the rating modal dialog.
     This runs once when the page loads.
  */
  function initRatingModal() {
    // Get references to modal elements
    const backdrop = document.getElementById("ratingModalBackdrop"); // Semi-transparent overlay
    const modal = document.getElementById("ratingModal");            // The modal dialog box
    const cancelBtn = document.getElementById("ratingCancelBtn");    // Cancel button at bottom
    const saveBtn = document.getElementById("ratingSaveBtn");        // Save button at bottom

    // Cancel button in modal footer
    cancelBtn.addEventListener("click", closeRatingModal);

    // Save button - calls function to save rating to Excel
    saveBtn.addEventListener("click", saveRatingToExcel);

    // Close modal when clicking on the dark overlay behind the modal
    // (but only if clicking directly on backdrop, not content inside)
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) {  // Check if click was on backdrop itself
        closeRatingModal();
      }
    });
  }

</script>

<!-- Notes Modal -->
<div id="notesModalBackdrop"></div>
<div id="notesModal">
  <div class="notes-modal-header">
    <div class="notes-modal-title" id="notesModalTitle">Add Notes</div>
    <button class="notes-modal-close" id="notesModalCloseBtn">&times;</button>
  </div>
  <div class="notes-modal-body">
    <!-- Preview of existing notes -->
    <div id="notesPreview"></div>
    <!-- Textarea for editing/adding notes -->
    <textarea id="notesTextarea" class="notes-textarea" placeholder="Add your notes here..."></textarea>
  </div>
  <div class="notes-modal-footer">
    <button class="notes-cancel-btn" id="notesCancelBtn">Cancel</button>
    <button class="notes-save-btn" id="notesSaveBtn">Save Notes</button>
  </div>
</div>

<!-- Rating Modal -->
<div id="ratingModalBackdrop"></div>
<div id="ratingModal">
  <div class="rating-modal-title" id="ratingModalTitle">Rate this Adventure</div>
  <div class="star-rating" id="starRating">
    <!-- Stars will be generated by JavaScript -->
  </div>
  <div class="rating-modal-footer">
    <button class="rating-cancel-btn" id="ratingCancelBtn">Cancel</button>
    <button class="rating-save-btn" id="ratingSaveBtn">Save Rating</button>
  </div>
</div>

</body>
</html>


