<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Adventure Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --mint-bg: #ecfdf5;
      --mint-border: #6ee7b7;
      --mint-strong: #10b981;
      --blue-bg: #e0f2fe;
      --blue-border: #60a5fa;
      --blue-strong: #1d4ed8;
      --gray-border: #d1d5db;
      --gray-text: #374151;
      --soft-yellow: #fef9c3;
      --soft-yellow-border: #facc15;
      --danger-red: #dc2626;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f9fafb;
      color: #111827;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    .iphone-toggle-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: white;
      color: var(--blue-strong);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .iphone-toggle-btn.active {
      background: var(--blue-bg);
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      background: white;
      border: 1px solid var(--gray-border);
      margin-bottom: 12px;
      font-size: 13px;
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .status-dot.connected {
      background: #22c55e;
    }

    .status-dot.disconnected {
      background: var(--danger-red);
    }

    .status-text {
      font-weight: 500;
    }

    .filters-active-badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--mint-bg);
      border: 1px solid var(--mint-border);
      color: var(--mint-strong);
      font-size: 11px;
      font-weight: 600;
      display: none;
    }

    .filters-active-badge.visible {
      display: inline-flex;
    }

    .card {
      background: white;
      border-radius: 10px;
      border: 1px solid var(--gray-border);
      padding: 12px 14px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      font-size: 12px;
      color: #6b7280;
    }

    .pill-button {
      border-radius: 999px;
      border: 1px solid var(--gray-border);
      background: #f3f4f6;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .pill-button:hover {
      background: #e5e7eb;
    }

    .pill-button.reset {
      border-color: var(--mint-border);
      color: var(--mint-strong);
      background: white;
    }

    .pill-button.reset:hover {
      background: var(--mint-bg);
    }

    .control-panel-card.filters-active,
    .quick-filters-card.filters-active {
      background: var(--mint-bg);
      border-color: var(--mint-border);
    }

    .control-panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      width: 100%;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-item label {
      font-size: 12px;
      color: #4b5563;
    }

    .filter-input,
    .filter-select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--gray-border);
      font-size: 13px;
      color: var(--gray-text);
      background: white;
    }

    .filter-input::placeholder {
      color: #9ca3af;
    }

    .quick-filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .quick-filter-btn {
      border-radius: 999px;
      border: 1px solid var(--gray-border);
      background: #f3f4f6;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .quick-filter-btn.active {
      background: var(--mint-bg);
      border-color: var(--mint-border);
      color: var(--mint-strong);
      font-weight: 600;
    }

    /* Google Automation Card */
    .automation-card {
      border-color: var(--blue-border);
      background: #f9fafb;
      padding: 0;
      overflow: hidden;
    }

    .automation-header {
      background: var(--blue-bg);
      border-bottom: 1px solid var(--blue-border);
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .automation-header-title {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--blue-strong);
    }

    .automation-body {
      padding: 10px 12px 12px;
    }

    .automation-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .automation-btn {
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: white;
      color: var(--blue-strong);
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .automation-btn:hover {
      background: var(--blue-bg);
    }

    .dry-run-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .dry-run-switch {
      width: 32px;
      height: 18px;
      border-radius: 999px;
      background: #e5e7eb;
      position: relative;
      transition: background 0.2s;
    }

    .dry-run-switch-thumb {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: white;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .dry-run-toggle.on .dry-run-switch {
      background: var(--blue-border);
    }

    .dry-run-toggle.on .dry-run-switch-thumb {
      transform: translateX(14px);
    }

    .dry-run-note {
      font-size: 11px;
      color: #6b7280;
    }

    /* Table */
    .table-card {
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 8px 8px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    th {
      text-align: left;
      font-size: 12px;
      color: #4b5563;
    }

    tr:hover {
      background: #f9fafb;
    }

    tr.row-selected {
      background: var(--soft-yellow);
      border-left: 4px solid var(--soft-yellow-border);
    }

    .text-cell-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .description-preview,
    .hours-preview {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      font-size: 12px;
      color: #4b5563;
    }

    .description-full,
    .hours-full {
      display: none;
      font-size: 12px;
      color: #4b5563;
    }

    .more-less-btn {
      align-self: flex-start;
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: var(--blue-bg);
      color: var(--blue-strong);
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    .more-less-btn:hover {
      background: #bfdbfe;
    }

    /* Tag pills (example base styles) */
    .tag-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin: 1px 2px 1px 0;
      color: #111827;
    }

    .tag-restaurant { background: #fee2e2; }
    .tag-animals { background: #dcfce7; }
    .tag-hiking { background: #dbeafe; }
    .tag-garden-center { background: #fef3c7; }
    .tag-orchards { background: #fef9c3; }
    .tag-ziplining { background: #e0f2fe; }
    .tag-market { background: #ede9fe; }
    .tag-scenic-drive { background: #e0f2fe; }
    .tag-nature { background: #dcfce7; }
    .tag-attractions { background: #e5e7eb; }
    .tag-used-book-store { background: #fef3c7; }

    /* Mobile / iPhone view overrides */
    body.mobile-view .control-panel-grid {
      grid-template-columns: 1fr;
    }

    body.mobile-view .quick-filters-container {
      flex-direction: column;
    }

    body.mobile-view .quick-filter-btn,
    body.mobile-view .pill-button.reset,
    body.mobile-view .automation-btn {
      width: 100%;
      text-align: center;
    }

    body.mobile-view table {
      font-size: 12px;
    }

    body.mobile-view th,
    body.mobile-view td {
      padding: 6px 6px;
    }

    body.mobile-view .iphone-toggle-btn {
      position: relative;
    }

    /* Simple modal shell for automation progress (placeholder) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 10px;
      padding: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-weight: 600;
      font-size: 14px;
    }

    .modal-close-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
    }

    .modal-body {
      font-size: 12px;
      color: #4b5563;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .primary-btn {
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: var(--blue-strong);
      color: white;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .primary-btn:hover {
      background: #1e40af;
    }

    .secondary-btn {
      border-radius: 999px;
      border: 1px solid var(--gray-border);
      background: white;
      color: var(--gray-text);
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .secondary-btn:hover {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
<div class="app-container">
  <header>
    <h1>Adventure Planner</h1>
    <button id="iphoneToggleBtn" class="iphone-toggle-btn">
      üì± iPhone View
    </button>
  </header>

  <div class="status-bar">
    <div class="status-left">
      <div id="connectionDot" class="status-dot disconnected"></div>
      <div class="status-text" id="connectionText">Not connected to Excel backend</div>
    </div>
    <span id="filtersActiveBadge" class="filters-active-badge">Filters Active</span>
  </div>

  <!-- Control Panel -->
  <div id="controlPanelCard" class="card control-panel-card">
    <div class="card-header">
      <div class="card-title">
        üéõÔ∏è Control Panel
      </div>
      <button id="resetAllFiltersTop" class="pill-button reset">Reset All Filters</button>
    </div>
    <div class="control-panel-grid">
      <div class="filter-item">
        <label for="searchName">Search by Name</label>
        <input id="searchName" class="filter-input" type="text" placeholder="Search adventures..." />
      </div>
      <div class="filter-item">
        <label for="filterDifficulty">Filter by Difficulty</label>
        <select id="filterDifficulty" class="filter-select">
          <option value="">Any</option>
          <option value="Easy">Easy</option>
          <option value="Moderate">Moderate</option>
          <option value="Hard">Hard</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterState">Filter by State</label>
        <input id="filterState" class="filter-input" type="text" placeholder="SC, NC, GA..." />
      </div>
      <div class="filter-item">
        <label for="filterCity">Filter by City</label>
        <input id="filterCity" class="filter-input" type="text" placeholder="Columbia, Greenville..." />
      </div>
      <div class="filter-item">
        <label for="filterTags">Filter by Tags</label>
        <input id="filterTags" class="filter-input" type="text" placeholder="Restaurant, Animals, Nature..." />
      </div>
      <div class="filter-item">
        <label for="filterCost">Filter by Cost</label>
        <input id="filterCost" class="filter-input" type="text" placeholder="Free, $, $$..." />
      </div>
      <div class="filter-item">
        <label for="groupBy">Group By</label>
        <select id="groupBy" class="filter-select">
          <option value="">None</option>
          <option value="State">State</option>
          <option value="City">City</option>
          <option value="Cost">Cost</option>
          <option value="Tag">Tag</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Common Filters -->
  <div id="quickFiltersCard" class="card quick-filters-card">
    <div class="card-header">
      <div class="card-title">
        üéõÔ∏è Common Filters
      </div>
      <button id="resetAllFiltersBottom" class="pill-button reset">Reset All Filters</button>
    </div>
    <div class="quick-filters-container">
      <button class="quick-filter-btn" data-tag="restaurant">Restaurant</button>
      <button class="quick-filter-btn" data-tag="animals">Animals</button>
      <button class="quick-filter-btn" data-tag="hiking">Hiking</button>
      <button class="quick-filter-btn" data-tag="garden center">Garden Center</button>
      <button class="quick-filter-btn" data-tag="orchards">Orchards</button>
      <button class="quick-filter-btn" data-tag="ziplining">Ziplining</button>
      <button class="quick-filter-btn" data-tag="market">Market</button>
      <button class="quick-filter-btn" data-tag="scenic drive">Scenic Drive</button>
      <button class="quick-filter-btn" data-tag="nature">Nature</button>
      <button class="quick-filter-btn" data-tag="attractions">Attractions</button>
      <button class="quick-filter-btn" data-tag="used book store">Used Book Store</button>
    </div>
  </div>

  <!-- Google Data Automation -->
  <div class="card automation-card">
    <div class="automation-header">
      <div class="automation-header-title">
        üîÑ Google Data Automation
      </div>
      <div id="dryRunToggle" class="dry-run-toggle on">
        <span>Dry Run</span>
        <div class="dry-run-switch">
          <div class="dry-run-switch-thumb"></div>
        </div>
      </div>
    </div>
    <div class="automation-body">
      <div class="automation-buttons">
        <button id="btnPopulateMissing" class="automation-btn">Populate Missing Fields</button>
        <button id="btnRefreshHours" class="automation-btn">Refresh Hours Only</button>
        <button id="btnRefreshAll" class="automation-btn">Refresh All Fields</button>
      </div>
      <div class="dry-run-note">
        Dry Run ON: changes are previewed but not written to Excel. Turn off to apply updates.
      </div>
    </div>
  </div>

  <!-- Adventure List -->
  <div class="card table-card">
    <div class="card-header">
      <div class="card-title">
        Adventure List
      </div>
      <div class="card-subtitle">
        Data source: Adventure_Finder_Excel_DB.xlsx (Table: MyList)
      </div>
    </div>
    <div class="table-wrapper">
      <table id="adventureTable">
        <thead>
        <tr>
          <th>Name</th>
          <th>City</th>
          <th>State</th>
          <th>Cost</th>
          <th>Difficulty</th>
          <th>Tags</th>
          <th>Description</th>
          <th>Hours of Operation</th>
        </tr>
        </thead>
        <tbody id="adventureTableBody">
        <!-- Example static row; real rows will be populated from Excel/Graph -->
        <tr>
          <td>Sample Adventure</td>
          <td>Columbia</td>
          <td>SC</td>
          <td>$</td>
          <td>Easy</td>
          <td>
            <span class="tag-pill tag-restaurant">Restaurant</span>
            <span class="tag-pill tag-nature">Nature</span>
          </td>
          <td>
            <div class="text-cell-wrapper">
              <div class="description-preview">
                A short sample description that shows how the preview will look when truncated to two lines...
              </div>
              <div class="description-full">
                A short sample description that shows how the preview will look when truncated to two lines, and this is the full version that appears when you click More. It can span multiple sentences and provide full context.
              </div>
              <button class="more-less-btn" data-type="description">More</button>
            </div>
          </td>
          <td>
            <div class="text-cell-wrapper">
              <div class="hours-preview">
                Mon‚ÄìFri: 9am‚Äì5pm; Sat: 10am‚Äì4pm; Sun: Closed
              </div>
              <div class="hours-full">
                Mon‚ÄìFri: 9am‚Äì5pm<br />
                Sat: 10am‚Äì4pm<br />
                Sun: Closed
              </div>
              <button class="more-less-btn" data-type="hours">More</button>
            </div>
          </td>
        </tr>
        <!-- More rows will be injected dynamically -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Automation Modal (placeholder) -->
<div id="automationModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Automation Progress</div>
      <button id="automationModalClose" class="modal-close-btn">&times;</button>
    </div>
    <div id="automationModalBody" class="modal-body">
      <!-- Progress and diff preview content will be injected here -->
      Preparing automation run...
    </div>
    <div class="modal-footer">
      <button id="automationApplyBtn" class="primary-btn">Apply Changes to Excel</button>
      <button id="automationCancelBtn" class="secondary-btn">Cancel</button>
    </div>
  </div>
</div>

<script>
  /***********************
   * CONFIG & CONSTANTS  *
   ***********************/
  const GOOGLE_API_KEY = "YOUR_API_KEY_HERE"; // Replace with your real key
  const EXCEL_TABLE_NAME = "MyList";
  const PLACE_ID_COLUMN_NAME = "Google Place ID";

  // MSAL config: your real clientId is preserved from your existing file.
  const msalConfig = {
    auth: {
      clientId: "YOUR_REAL_CLIENT_ID_HERE", // keep your existing value here
      authority: "https://login.microsoftonline.com/common",
      redirectUri: window.location.origin
    }
  };

  // Placeholder MSAL/Graph objects (wire to your existing logic)
  let msalInstance = null;
  let graphClient = null;
  let isConnectedToExcel = false;

  /***********************
   * INITIALIZATION      *
   ***********************/
  document.addEventListener("DOMContentLoaded", () => {
    initConnectionStatus();
    initIphoneToggle();
    initFilters();
    initQuickFilters();
    initResetButtons();
    initMoreLessButtons();
    initRowSelection();
    initDryRunToggle();
    initAutomationButtons();
  });

  function initConnectionStatus() {
    // Hook this to your real MSAL/Graph connection logic.
    // For now, we assume disconnected until your existing code sets it.
    updateConnectionStatus(isConnectedToExcel);
  }

  function updateConnectionStatus(connected) {
    const dot = document.getElementById("connectionDot");
    const text = document.getElementById("connectionText");
    if (connected) {
      dot.classList.remove("disconnected");
      dot.classList.add("connected");
      text.textContent = "Connected to Excel backend";
    } else {
      dot.classList.remove("connected");
      dot.classList.add("disconnected");
      text.textContent = "Not connected to Excel backend";
    }
  }

  /***********************
   * IPHONE VIEW TOGGLE  *
   ***********************/
  function initIphoneToggle() {
    const btn = document.getElementById("iphoneToggleBtn");
    btn.addEventListener("click", () => {
      document.body.classList.toggle("mobile-view");
      const isMobile = document.body.classList.contains("mobile-view");
      if (isMobile) {
        btn.classList.add("active");
        btn.textContent = "üíª Desktop View";
      } else {
        btn.classList.remove("active");
        btn.textContent = "üì± iPhone View";
      }
    });
  }

  /***********************
   * FILTERING LOGIC     *
   ***********************/
  const filterState = {
    name: "",
    difficulty: "",
    state: "",
    city: "",
    tags: "",
    cost: "",
    groupBy: "",
    quickTags: new Set()
  };

  function initFilters() {
    document.getElementById("searchName").addEventListener("input", e => {
      filterState.name = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("filterDifficulty").addEventListener("change", e => {
      filterState.difficulty = e.target.value;
      applyFilters();
    });
    document.getElementById("filterState").addEventListener("input", e => {
      filterState.state = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("filterCity").addEventListener("input", e => {
      filterState.city = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("filterTags").addEventListener("input", e => {
      filterState.tags = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("filterCost").addEventListener("input", e => {
      filterState.cost = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    document.getElementById("groupBy").addEventListener("change", e => {
      filterState.groupBy = e.target.value;
      applyFilters();
    });
  }

  function initQuickFilters() {
    const quickButtons = document.querySelectorAll(".quick-filter-btn");
    quickButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tag = btn.getAttribute("data-tag");
        if (filterState.quickTags.has(tag)) {
          filterState.quickTags.delete(tag);
          btn.classList.remove("active");
        } else {
          filterState.quickTags.add(tag);
          btn.classList.add("active");
        }
        applyFilters();
      });
    });
  }

  function initResetButtons() {
    const topReset = document.getElementById("resetAllFiltersTop");
    const bottomReset = document.getElementById("resetAllFiltersBottom");
    topReset.addEventListener("click", resetAllFilters);
    bottomReset.addEventListener("click", resetAllFilters);
  }

  function resetAllFilters() {
    filterState.name = "";
    filterState.difficulty = "";
    filterState.state = "";
    filterState.city = "";
    filterState.tags = "";
    filterState.cost = "";
    filterState.groupBy = "";
    filterState.quickTags.clear();

    document.getElementById("searchName").value = "";
    document.getElementById("filterDifficulty").value = "";
    document.getElementById("filterState").value = "";
    document.getElementById("filterCity").value = "";
    document.getElementById("filterTags").value = "";
    document.getElementById("filterCost").value = "";
    document.getElementById("groupBy").value = "";

    document.querySelectorAll(".quick-filter-btn").forEach(btn => {
      btn.classList.remove("active");
    });

    applyFilters();
  }

  function applyFilters() {
    // Hook this into your existing filtering + grouping logic.
    // For now, we only update visual filter state indicators.

    const anyFilterActive =
            filterState.name ||
            filterState.difficulty ||
            filterState.state ||
            filterState.city ||
            filterState.tags ||
            filterState.cost ||
            filterState.groupBy ||
            filterState.quickTags.size > 0;

    const controlPanelCard = document.getElementById("controlPanelCard");
    const quickFiltersCard = document.getElementById("quickFiltersCard");
    const badge = document.getElementById("filtersActiveBadge");

    if (anyFilterActive) {
      controlPanelCard.classList.add("filters-active");
      quickFiltersCard.classList.add("filters-active");
      badge.classList.add("visible");
    } else {
      controlPanelCard.classList.remove("filters-active");
      quickFiltersCard.classList.remove("filters-active");
      badge.classList.remove("visible");
    }

    // Your real implementation:
    // - Filter rows based on filterState
    // - Optionally group rows based on filterState.groupBy
    // - Re-render table body
  }

  /***********************
   * MORE / LESS TOGGLE  *
   ***********************/
  function initMoreLessButtons() {
    document.querySelectorAll(".more-less-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.getAttribute("data-type"); // "description" or "hours"
        const wrapper = btn.closest(".text-cell-wrapper");
        if (!wrapper) return;

        if (type === "description") {
          const preview = wrapper.querySelector(".description-preview");
          const full = wrapper.querySelector(".description-full");
          const isExpanded = full.style.display === "block";
          if (isExpanded) {
            full.style.display = "none";
            preview.style.display = "-webkit-box";
            btn.textContent = "More";
          } else {
            full.style.display = "block";
            preview.style.display = "none";
            btn.textContent = "Less";
          }
        } else if (type === "hours") {
          const preview = wrapper.querySelector(".hours-preview");
          const full = wrapper.querySelector(".hours-full");
          const isExpanded = full.style.display === "block";
          if (isExpanded) {
            full.style.display = "none";
            preview.style.display = "-webkit-box";
            btn.textContent = "More";
          } else {
            full.style.display = "block";
            preview.style.display = "none";
            btn.textContent = "Less";
          }
        }
      });
    });
  }

  /***********************
   * ROW SELECTION       *
   ***********************/
  function initRowSelection() {
    const tbody = document.getElementById("adventureTableBody");
    tbody.addEventListener("click", (e) => {
      const row = e.target.closest("tr");
      if (!row) return;

      // Clear previous selection
      tbody.querySelectorAll("tr").forEach(r => r.classList.remove("row-selected"));
      // Apply to clicked row
      row.classList.add("row-selected");
    });
  }

  /***********************
   * DRY RUN TOGGLE      *
   ***********************/
  function initDryRunToggle() {
    const toggle = document.getElementById("dryRunToggle");
    toggle.addEventListener("click", () => {
      toggle.classList.toggle("on");
      // You can read this state when running automation:
      // const dryRun = toggle.classList.contains("on");
    });
  }

  /***********************
   * AUTOMATION BUTTONS  *
   ***********************/
  function initAutomationButtons() {
    document.getElementById("btnPopulateMissing").addEventListener("click", () => {
      startAutomationRun("populate-missing");
    });
    document.getElementById("btnRefreshHours").addEventListener("click", () => {
      startAutomationRun("refresh-hours");
    });
    document.getElementById("btnRefreshAll").addEventListener("click", () => {
      startAutomationRun("refresh-all");
    });

    document.getElementById("automationModalClose").addEventListener("click", closeAutomationModal);
    document.getElementById("automationCancelBtn").addEventListener("click", closeAutomationModal);
    document.getElementById("automationApplyBtn").addEventListener("click", () => {
      // In real implementation, apply diff to Excel here.
      closeAutomationModal();
    });
  }

  function startAutomationRun(mode) {
    const dryRun = document.getElementById("dryRunToggle").classList.contains("on");
    openAutomationModal(`Starting ${mode} (Dry Run: ${dryRun ? "ON" : "OFF"})...`);

    // Placeholder: here you would:
    // 1. Read rows from Excel (Graph API, table: MyList).
    // 2. For each row, use "Google Place ID" + GOOGLE_API_KEY to call:
    //    - Places Details API
    //    - Distance Matrix API
    // 3. Build a diff of proposed changes.
    // 4. If dryRun: show diff only.
    //    If not dryRun: write changes back to Excel.
  }

  function openAutomationModal(initialText) {
    const backdrop = document.getElementById("automationModalBackdrop");
    const body = document.getElementById("automationModalBody");
    body.textContent = initialText || "Preparing automation run...";
    backdrop.classList.add("visible");
  }

  function closeAutomationModal() {
    const backdrop = document.getElementById("automationModalBackdrop");
    backdrop.classList.remove("visible");
  }
</script>
</body>
</html>
